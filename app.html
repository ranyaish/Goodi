<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>גודי שוברים - מערכת ניהול</title>

  <!-- ✅ טוען את הבוטסטרפ היחיד של Supabase (יוצר window.supabase.client + window.supabaseReady) -->
  <script src="./supabaseClient.js"></script>

  <style>
    body{font-family:system-ui,Arial,Heebo,sans-serif;background:#fff;color:#111;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eee}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:6px;object-fit:cover}
    h1{font-size:22px;margin:0}
    .wrap{max-width:920px;margin:20px auto;padding:0 14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
    button{border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.ghost{background:#fff;color:#111}
    .muted{color:#6b7280;font-size:14px}
    .list{list-style:none;padding:0;margin:10px 0 0}
    .list li{padding:6px 0;border-bottom:1px dashed #eee}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .pill{font-size:12px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:3px 8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:right}
    thead th{background:#f8fafc}
  </style>
</head>
<body>

  <!-- ====== פס עליון קטן: ריצה אחרונה מגיטהאב (קומפקטי) ====== -->
  <div id="wf-mini" style="direction:rtl;max-width:760px;margin:16px auto 0;font-family:system-ui">
    <div style="font-size:13px;color:#6b7280;margin-bottom:6px">עדכון אחרון</div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px">
      <span id="wf-mini-run" style="font-family:ui-monospace,Menlo,Consolas,monospace">—</span>
      <span id="wf-mini-status" style="border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;color:#6b7280">—</span>
      <span id="wf-mini-time" style="color:#6b7280">—</span>
      <a id="wf-mini-url" target="_blank" rel="noopener" style="margin-inline-start:auto;color:#2563eb;text-decoration:none">פתח לוג</a>
    </div>
  </div>
  <script>
  (async () => {
    const repo = 'ranyaish/Goodi';
    const url  = `https://api.github.com/repos/${repo}/actions/runs?per_page=1`;
    const $ = id => document.getElementById(id);
    const runEl=$('wf-mini-run'), stEl=$('wf-mini-status'), tEl=$('wf-mini-time'), aEl=$('wf-mini-url');
    async function loadOne(){
      try{
        const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json'},cache:'no-store'});
        if(!r.ok) throw new Error();
        const js=await r.json(); const x=js.workflow_runs?.[0]; if(!x) throw new Error();
        runEl.textContent=`run #${x.run_number}`; aEl.href=x.html_url;
        tEl.textContent=new Date(x.created_at).toLocaleString('he-IL',{hour12:false});
        const s=(x.conclusion||x.status||'').toLowerCase();
        stEl.textContent=s||'—';
        stEl.style.background=s==='success'?'#ecfdf5':(s==='failure'||s==='cancelled'?'#fef2f2':'#f3f4f6');
        stEl.style.color     =s==='success'?'#065f46':(s==='failure'||s==='cancelled'?'#991b1b':'#374151');
        stEl.style.borderColor=s==='success'?'#a7f3d0':(s==='failure'||s==='cancelled'?'#fecaca':'#e5e7eb');
      }catch(_){ /* שקט */ }
    }
    loadOne(); setInterval(loadOne,5*60*1000);
  })();
  </script>
  <!-- ====== /פס ריצה אחרונה ====== -->

  <header>
    <div class="brand">
      <img src="logo.png" alt="לוגו" />
      <h1>גודי שוברים - מערכת ניהול</h1>
    </div>
    <div class="row">
      <button id="logoutBtn" class="ghost">יציאה</button>
    </div>
  </header>

  <div class="wrap">

    <!-- כניסה בסיסית -->
    <div id="login-box" class="card">
      <div class="row" style="justify-content:space-between">
        <strong>כניסה</strong>
        <small class="muted">admin / 1234</small>
      </div>
      <form onsubmit="return false" class="row" style="margin-top:8px">
        <input id="login-user" placeholder="שם משתמש" style="flex:1 1 180px;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
        <input id="login-pass" placeholder="סיסמה" type="password" style="flex:1 1 180px;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
        <button id="login-btn">התחבר</button>
        <div id="login-msg" style="color:#991b1b"></div>
      </form>
    </div>

    <!-- לוג עדכונים אחרונים (מה-DB) -->
    <div class="card">
      <div class="row">
        <strong>לוג עדכונים אחרונים</strong>
        <span id="logMeta" class="pill">—</span>
        <div class="spacer"></div>
        <button id="refreshLog" class="ghost">רענן</button>
      </div>
      <ul id="logList" class="list">
        <li class="muted">טוען…</li>
      </ul>
    </div>

    <!-- בחירת לקוח -->
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <button id="pickCustomer">בחר לקוח</button>
        <div class="spacer"></div>
        <span class="muted">לקוח נוכחי</span>
      </div>
      <input id="currentCustomer" class="muted" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px" placeholder="לא נבחר" disabled />
      <div id="customerSummary" class="muted" style="margin-top:8px">—</div>
    </div>

    <!-- טבלת שוברים -->
    <div id="customerCoupons" class="card" style="display:none">
      <div class="row">
        <strong>שוברים</strong>
        <div class="spacer"></div>
        <span id="couponMeta" class="pill">—</span>
      </div>
      <div id="couponTable" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
  // ===== כניסה מקומית (ללא שרת) =====
  (function(){
    const LS_KEY='goodi_is_logged_in';
    const box=document.getElementById('login-box');
    if(localStorage.getItem(LS_KEY)==='1'){ box.style.display='none'; document.documentElement.dataset.goodiAuthed='1'; }
    document.getElementById('login-btn').addEventListener('click',()=>{
      const u=document.getElementById('login-user').value.trim();
      const p=document.getElementById('login-pass').value.trim();
      if(u==='admin' && p==='1234'){
        localStorage.setItem(LS_KEY,'1'); box.style.display='none';
        document.documentElement.dataset.goodiAuthed='1';
        document.dispatchEvent(new CustomEvent('goodi:authed'));
      }else{
        const m=document.getElementById('login-msg'); m.textContent='שגיאת התחברות';
        setTimeout(()=>m.textContent='',2000);
      }
    });
    document.getElementById('logoutBtn').onclick=()=>{ try{localStorage.clear();sessionStorage.clear();}catch(_){} location.reload(); };
  })();

  // ===== שימוש ב-Supabase דרך supabaseClient.js =====
  (async function(){
    const ready = await window.supabaseReady;      // ← נחכה לבוטסטרפ
    if(!ready || !ready.ok){ console.warn('supabase bootstrap failed'); return; }
    const supabase = ready.client;

    // --- לוג (5 אחרונים) ---
    async function loadImportLogs(){
      const $list=document.getElementById('logList');
      const $meta=document.getElementById('logMeta');
      $list.innerHTML='<li class="muted">טוען…</li>';
      const { data, error } = await supabase.from('import_logs').select('*').order('run_time',{ascending:false}).limit(5);
      if(error){ $list.innerHTML='<li class="muted">שגיאה בטעינת לוגים</li>'; $meta.textContent='שגיאה'; return; }
      if(!data?.length){ $list.innerHTML='<li class="muted">אין ריצות קודמות</li>'; $meta.textContent='0'; return; }
      $list.innerHTML=''; data.forEach(row=>{
        const li=document.createElement('li');
        const dt=new Date(row.run_time).toLocaleString('he-IL');
        li.textContent=`${dt} — ${row.records_imported} רשומות (${row.status})`;
        $list.appendChild(li);
      });
      $meta.textContent=`סה״כ: ${data.length}`;
    }
    document.getElementById('refreshLog').onclick=loadImportLogs;
    loadImportLogs();

    // --- בחירת לקוח + טעינת שוברים ---
    async function pickCustomer(){
      if(document.documentElement.dataset.goodiAuthed!=='1'){ alert('יש להתחבר'); return; }
      const { data, error } = await supabase.from('customers').select('customer_id,name').order('name',{ascending:true}).limit(200);
      if(error || !data?.length){ alert('לא נמצאו לקוחות'); return; }
      const picked = prompt('בחר לקוח (הקלד בדיוק אחד מהשמות):\n\n'+data.map(c=>c.name).join('\n'));
      if(!picked) return;
      const row = data.find(c=>c.name===picked);
      if(!row){ alert('לא נמצא'); return; }

      document.getElementById('currentCustomer').value = row.name || '(ללא שם)';
      document.getElementById('customerSummary').textContent = `מזהה: ${row.customer_id ?? '-'}`;

      const { data: coupons, error: cErr } = await supabase
        .from('coupons')
        .select('id,date,amount,redeemed,redeemed_at')
        .eq('customer_id', row.customer_id)
        .order('date',{ascending:false});

      const $wrap=document.getElementById('customerCoupons');
      const $tbl =document.getElementById('couponTable');
      const $meta=document.getElementById('couponMeta');

      if(cErr){ $wrap.style.display='block'; $tbl.innerHTML='<div class="muted">שגיאה בטעינת שוברים</div>'; $meta.textContent='שגיאה'; return; }
      if(!coupons?.length){ $wrap.style.display='block'; $tbl.innerHTML='<div class="muted">אין שוברים ללקוח</div>'; $meta.textContent='0'; return; }

      const rows=coupons.map(c=>`
        <tr>
          <td>${new Date(c.date).toLocaleDateString('he-IL')}</td>
          <td>₪ ${Number(c.amount||0).toFixed(2)}</td>
          <td>${c.redeemed?'✔︎':'—'}</td>
        </tr>`).join('');

      $wrap.style.display='block';
      $meta.textContent=String(coupons.length);
      $tbl.innerHTML=`
        <table>
          <thead><tr><th>תאריך</th><th>סכום</th><th>מומש</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }
    document.getElementById('pickCustomer').onclick=pickCustomer;
  })();
  </script>
</body>
</html>
