<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מערכת – גודי שוברים</title>
  <style>
    body{font-family:system-ui,Arial,Heebo,sans-serif;background:#fff;color:#111;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eee}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:6px;object-fit:cover}
    h1{font-size:22px;margin:0}
    .wrap{max-width:920px;margin:20px auto;padding:0 14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .muted{color:#6b7280}
    .pill{font-size:12px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:3px 8px}
    button{border:1px solid #e5e7eb;background:#0ea5e9;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.ghost{background:#fff;color:#111}
    button.small{padding:6px 10px;border-radius:8px}
    button.small.ghost{background:#fff;color:#111}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:right;vertical-align:middle}
    thead th{background:#f8fafc}
    td.actions{white-space:nowrap}
    /* מיני־לוג למעלה */
    #wf-mini{direction:rtl;max-width:920px;margin:14px auto 0;font-family:inherit;padding:0 14px}
    #wf-mini .box{display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
  </style>

  <!-- Supabase bootstrap שלך (מחייב) -->
  <script src="./supabaseClient.js"></script>
</head>
<body>

  <!-- מיני־לוג (ריצה אחרונה) -->
  <div id="wf-mini">
    <div class="muted" style="font-size:13px;margin-bottom:6px">עדכון אחרון</div>
    <div class="box">
      <span id="wf-mini-run" style="font-family:ui-monospace,Menlo,Consolas,monospace">—</span>
      <span id="wf-mini-status" class="pill">—</span>
      <span id="wf-mini-time" class="muted">—</span>
      <a id="wf-mini-url" target="_blank" rel="noopener" style="margin-inline-start:auto;color:#2563eb;text-decoration:none">פתח לוג</a>
    </div>
  </div>

  <header>
    <div class="brand">
      <img src="logo.png" alt="לוגו" />
      <h1>מערכת – גודי שוברים</h1>
    </div>
    <div class="row">
      <button id="logoutBtn" class="ghost">יציאה</button>
    </div>
  </header>

  <div class="wrap">
    <!-- בחירת לקוח -->
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <button id="pickCustomer">בחר לקוח</button>
        <div class="spacer"></div>
        <span class="muted">לקוח נוכחי</span>
      </div>
      <input id="currentCustomer" class="muted" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px" placeholder="לא נבחר" disabled />
      <div id="customerSummary" class="muted" style="margin-top:8px">—</div>
    </div>

    <!-- טבלת שוברים -->
    <div id="customerCoupons" class="card" style="display:none">
      <div class="row" style="gap:12px">
        <strong>שוברים</strong>
        <div class="pill" id="freeTotal">פנוי למימוש: —</div>
        <div class="spacer"></div>
        <span id="couponMeta" class="pill">—</span>
      </div>
      <div id="couponTable" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ====== ריצה אחרונה (קומפקטית) ======
    (function miniRun(){
      const repo = 'ranyaish/Goodi';
      const url  = `https://api.github.com/repos/${repo}/actions/runs?per_page=1`;
      const $ = id => document.getElementById(id);
      const runEl = $('wf-mini-run'), stEl = $('wf-mini-status'), tEl = $('wf-mini-time'), aEl = $('wf-mini-url');

      async function loadOne(){
        try{
          const r = await fetch(url,{headers:{'Accept':'application/vnd.github+json'},cache:'no-store'});
          if(!r.ok) throw new Error('HTTP '+r.status);
          const js = await r.json();
          const x  = js.workflow_runs?.[0];
          if(!x) throw new Error('אין ריצות');

          runEl.textContent = `run #${x.run_number}`;
          aEl.href = x.html_url;
          tEl.textContent = new Date(x.created_at).toLocaleString('he-IL',{hour12:false});

          const s = (x.conclusion || x.status || '').toLowerCase();
          stEl.textContent = s || '—';
          stEl.style.background = s==='success' ? '#ecfdf5' : (s==='failure'||s==='cancelled' ? '#fef2f2' : '#f3f4f6');
          stEl.style.color      = s==='success' ? '#065f46' : (s==='failure'||s==='cancelled' ? '#991b1b' : '#374151');
          stEl.style.borderColor= s==='success' ? '#a7f3d0' : (s==='failure'||s==='cancelled' ? '#fecaca' : '#e5e7eb');
        }catch(e){
          runEl.textContent='—'; stEl.textContent='שגיאה'; tEl.textContent=''; aEl.removeAttribute('href');
        }
      }
      loadOne(); setInterval(loadOne, 5*60*1000);
    })();

    // ====== חיבור ל-Supabase (דרך הסקריפט שלך) ======
    let sb = null; // הלקוח

    (async () => {
      const ready = await window.supabaseReady;
      if (ready && ready.ok && ready.client) sb = ready.client;
      else alert('לא מצליח להתחבר ל־Supabase');
    })();

    // ====== יציאה ======
    document.getElementById('logoutBtn').onclick = () => {
      try { localStorage.clear(); sessionStorage.clear(); } catch (_){}
      location.reload();
    };

    // ====== בחירת לקוח בסיסית (prompt) ======
    let currentCustomer = null;  // { id, name }

    async function pickCustomer() {
      if (!sb) return alert('חיבור ל־DB עדיין לא מוכן');

      const { data, error } = await sb
        .from('customers')
        .select('customer_id,name')
        .order('name',{ascending:true});

      if (error) return alert('שגיאה בטעינת לקוחות');
      if (!data || !data.length) return alert('אין לקוחות');

      const names = data.map(c=>c.name).join('\n');
      const picked = prompt('בחר לקוח (הקלד בדיוק):\n\n'+names);
      if(!picked) return;

      const row = data.find(c=>c.name===picked);
      if(!row) return alert('לא נמצא');

      currentCustomer = { id: row.customer_id, name: row.name };
      document.getElementById('currentCustomer').value = row.name;
      document.getElementById('customerSummary').textContent = `מזהה: ${row.customer_id ?? '-'}`;
      await loadCustomer();
    }
    document.getElementById('pickCustomer').onclick = pickCustomer;

    // ====== טעינת שוברים ללקוח ======
    async function loadCustomer(){
      if (!currentCustomer || !sb) return;

      const $wrap = document.getElementById('customerCoupons');
      const $tbl  = document.getElementById('couponTable');
      const $meta = document.getElementById('couponMeta');
      const $free = document.getElementById('freeTotal');

      $wrap.style.display = 'block';
      $tbl.innerHTML = `<div class="muted">טוען…</div>`;
      $meta.textContent = '—';
      $free.textContent = 'פנוי למימוש: —';

      const { data: coupons, error: cErr } = await sb
        .from('coupons')
        .select('id,date,amount,redeemed,redeemed_at')
        .eq('customer_id', currentCustomer.id)
        .order('date',{ascending:false});

      if (cErr) {
        $tbl.innerHTML = `<div class="muted">שגיאה בטעינת שוברים</div>`;
        $meta.textContent = 'שגיאה';
        return;
      }
      if (!coupons || !coupons.length) {
        $tbl.innerHTML = `<div class="muted">אין שוברים ללקוח</div>`;
        $meta.textContent = '0';
        return;
      }

      // סכום כולל פנוי
      const freeSum = coupons
        .filter(c=>!c.redeemed)
        .reduce((s,c)=>s + Number(c.amount||0), 0);
      $free.textContent = 'פנוי למימוש: ₪ ' + freeSum.toFixed(2);

      $meta.textContent = String(coupons.length);

      const rows = coupons.map(c=>{
        const d = c.date ? new Date(c.date).toLocaleDateString('he-IL') : '—';
        const amt = `₪ ${Number(c.amount||0).toFixed(2)}`;
        const redeemedAtText = (c.redeemed && c.redeemed_at)
          ? new Date(c.redeemed_at).toLocaleString('he-IL')
          : '—';
        const actions = c.redeemed
          ? `<button type="button" class="small ghost" data-action="unredeem" data-id="${c.id}">בטל מימוש</button>`
          : `<button type="button" class="small" data-action="redeem" data-id="${c.id}">מימוש</button>`;
        return `<tr>
          <td>${d}</td>
          <td>${amt}</td>
          <td>${redeemedAtText}</td>
          <td class="actions">${actions}</td>
        </tr>`;
      }).join('');

      $tbl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>תאריך</th>
              <th>סכום</th>
              <th>מימוש (תאריך)</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;

      // חיבור האקשנים
      $tbl.querySelectorAll('[data-action="redeem"]').forEach(btn=>{
        btn.addEventListener('click', ()=>handleRedeem(btn.dataset.id));
      });
      $tbl.querySelectorAll('[data-action="unredeem"]').forEach(btn=>{
        btn.addEventListener('click', ()=>handleUnredeem(btn.dataset.id));
      });
    }

    // ====== מימוש שובר (מוסיף redeemed_at) ללא "קפיצה" ======
    async function handleRedeem(couponId){
      if (!currentCustomer || !sb) return;
      const y = window.scrollY; // שמירת מיקום הגלילה
      const { error } = await sb.from('coupons').update({
        redeemed: true,
        redeemed_at: new Date().toISOString()
      }).eq('id', couponId).limit(1);
      if (error) { alert('שגיאה במימוש'); return; }
      await loadCustomer();
      window.scrollTo(0, y);    // החזרת המיקום
    }

    // ====== ביטול מימוש (דורש שם מאשר) ללא "קפיצה" ======
    async function handleUnredeem(couponId){
      if (!currentCustomer || !sb) return;
      const approver = prompt('שם המאשר ביטול מימוש (חובה):');
      if(!approver || !approver.trim()){ alert('נדרש שם מאשר'); return; }
      const y = window.scrollY;
      const { error } = await sb.from('coupons').update({
        redeemed: false,
        redeemed_at: null
      }).eq('id', couponId).limit(1);
      if (error) { alert('שגיאה בביטול'); return; }
      await loadCustomer();
      window.scrollTo(0, y);
    }
  </script>
</body>
</html>
