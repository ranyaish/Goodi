<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>גודי שוברים - מערכת ניהול</title>

<!-- supabase-js עם Fallback -->
<script>
(function loadSupabase(){
  const urls=[
    "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js"
  ];
  (function go(i){
    if(i>=urls.length){document.dispatchEvent(new Event("supabase-ready"));return;}
    const s=document.createElement("script");s.src=urls[i];s.async=true;
    s.onload=()=>document.dispatchEvent(new Event("supabase-ready"));
    s.onerror=()=>go(i+1);document.head.appendChild(s);
  })(0);
})();
</script>

<style>
:root{
  --bg:#ffffff; --card:#ffffff; --muted:#5b6b7a; --text:#0f172a; --line:#e5e7eb;
  --blue:#0ea5e9; --red:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Heebo,Arial}
header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);
  padding:12px 16px;border-bottom:1px solid var(--line)}
.container{max-width:860px;margin:20px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
input,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text)}
button{cursor:pointer}
button.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
button.warn{background:var(--red);color:#fff;border-color:var(--red)}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--line);text-align:right}
thead th{position:sticky;top:64px;background:#fff}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.hint{color:var(--muted);font-size:13px}

/* מודאל בחירת לקוח */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999;
}
.modal{
  background:#fff;border:1px solid var(--line);border-radius:14px;max-width:560px;width:90%;padding:14px;
}
.modal h3{margin:0 0 8px 0}
.list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
.list button{display:block;width:100%;text-align:right;border:0;border-bottom:1px solid var(--line);background:#fff;padding:10px}
.list button:last-child{border-bottom:0}
</style>
</head>
<body>
<header>
  <div class="container"><b>גודי שוברים - מערכת ניהול</b></div>
</header>

<div class="container">

  <!-- פס פעולה ראשי: בחירת לקוח (שדות Supabase מוסתרים; חיבור אוטומטי) -->
  <div class="card">
    <div class="row" style="align-items:end">
      <div class="col">
        <label>לקוח נוכחי</label>
        <input id="currentCustomer" placeholder="לא נבחר" disabled/>
      </div>
      <div class="col" style="flex:0 0 220px">
        <button id="btnPick" class="primary">בחר לקוח</button>
      </div>
      <div class="col" style="flex:0 0 160px">
        <button id="btnReload" title="רענן רשימת לקוחות">רענן לקוחות</button>
      </div>
    </div>
    <div id="connStatus" class="hint" style="margin-top:8px">מחבר…</div>
  </div>

  <!-- פרטי לקוח (רק רשימת שוברים, ללא סכומי על) -->
  <div class="card" id="custCard" style="display:none">
    <div class="row">
      <div class="col"><b id="custTitle">לקוח</b></div>
      <div class="col" style="flex:0 0 200px;align-self:end"><button id="btnClose">סגור כרטיס</button></div>
    </div>
    <div id="couponTable" style="margin-top:10px"></div>
  </div>

</div>

<!-- מודאל בחירת לקוח -->
<div id="modalPick" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>בחר לקוח</h3>
    <div class="row" style="margin-bottom:10px">
      <div class="col">
        <label>חיפוש שם לקוח</label>
        <input id="searchInput" placeholder="הקלד כדי לסנן…"/>
      </div>
      <div class="col" style="flex:0 0 160px;align-self:end">
        <button id="btnCloseModal">סגור</button>
      </div>
    </div>
    <div id="listWrap" class="list"></div>
  </div>
</div>

<script>
/* ===== Utils ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmtILS(n){ return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0)); }
function safeMsg(e){return (e&&(e.message||e.statusText||e.name))||String(e||'Unknown');}
function isoToDDMMYYYY(iso){ if(!iso) return ''; const [y,m,d]=String(iso).split('-'); if(!y||!m||!d) return iso; return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`; }

/* ===== Supabase (מוסתר – טעינה אוטומטית) ===== */
const DEFAULT_URL="https://ylqpxwgchwalcblfipsu.supabase.co";
const DEFAULT_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";
let supabase=null, customersCache=[], customersLoaded=false;

async function init(){
  try{
    if(!window.supabase){ $('#connStatus').textContent='ספריית Supabase לא נטענה'; return; }
    supabase = window.supabase.createClient(
      localStorage.getItem('sb_url')||DEFAULT_URL,
      localStorage.getItem('sb_key')||DEFAULT_KEY
    );
    const { error } = await supabase.auth.getSession();
    $('#connStatus').textContent = error?('שגיאה: '+error.message):'מחובר ל-Supabase';
    await loadCustomers(true);
  }catch(e){
    $('#connStatus').textContent='שגיאת חיבור: '+safeMsg(e);
  }
}
document.addEventListener('supabase-ready', init);

/* ===== מודאל בחירת לקוח ===== */
function openModal(){
  // אם עוד לא נטען — נטען עכשיו ואז נפתח
  if(!customersLoaded){ loadCustomers(true).then(()=>{ openModalNow(); }); }
  else { openModalNow(); }
}
function openModalNow(){
  $('#modalPick').style.display='flex';
  $('#searchInput').value='';
  $('#searchInput').focus();
  renderList(customersCache);
}
function closeModal(){ $('#modalPick').style.display='none'; }
$('#btnPick').addEventListener('click', openModal);
$('#btnCloseModal').addEventListener('click', closeModal);
$('#btnClose').addEventListener('click', ()=>{ $('#custCard').style.display='none'; $('#currentCustomer').value='לא נבחר'; });

$('#btnReload').addEventListener('click', ()=> loadCustomers(true));

$('#searchInput').addEventListener('input', ()=>{
  const q=$('#searchInput').value.toLowerCase().trim();
  const list = !q ? customersCache : customersCache.filter(c=> c.name.toLowerCase().includes(q));
  renderList(list);
});

// האזנת קליקים עם האצלת אירועים כדי לתפוס גם כפתורים שנוצרו דינאמית
$('#listWrap').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button[data-id]');
  if(!btn) return;
  const cid = btn.dataset.id;
  const name = btn.dataset.name || btn.textContent.trim();
  $('#currentCustomer').value = name;
  closeModal();
  openCustomer(cid, name);
});

function renderList(list){
  const el=$('#listWrap');
  if(!list.length){ el.innerHTML='<div style="padding:10px" class="hint">לא נמצאו לקוחות</div>'; return; }
  el.innerHTML = list.map(c=>`<button type="button" data-id="${c.customer_id}" data-name="${c.name}">${c.name}</button>`).join('');
}

/* ===== נתוני לקוחות ===== */
async function loadCustomers(showCount=false){
  try{
    $('#connStatus').textContent='טוען לקוחות…';
    const { data, error } = await supabase.from('customers').select('customer_id,name').order('name');
    if(error){ $('#connStatus').textContent='שגיאה בטעינת לקוחות: '+safeMsg(error); return; }
    customersCache = data||[];
    customersLoaded = true;
    $('#connStatus').textContent = showCount ? `מחובר • נטענו ${customersCache.length} לקוחות` : 'מחובר';
  }catch(e){
    $('#connStatus').textContent='שגיאה בטעינה: '+safeMsg(e);
  }
}

/* ===== פרטי לקוח (רשימת שוברים בלבד) ===== */
async function openCustomer(customerId, name){
  try{
    const displayName = name || (await supabase.from('customers').select('name').eq('customer_id',customerId).single()).data?.name || 'לקוח';
    $('#custTitle').textContent='לקוח: '+displayName;

    const { data: rows, error } = await supabase.from('coupons')
      .select('id,date,amount,redeemed,redeemed_at')
      .eq('customer_id', customerId).order('date',{ascending:false});
    if(error){ alert('שגיאת קריאה: '+safeMsg(error)); return; }

    let html='<table><thead><tr><th>תאריך</th><th>סכום</th><th>סטטוס</th><th>פעולה</th></tr></thead><tbody>';
    (rows||[]).forEach(r=>{
      const status = r.redeemed ? `✔️ <span class="badge">${r.redeemed_at? new Date(r.redeemed_at).toLocaleString('he-IL'):''}</span>` : '';
      const label  = r.redeemed ? 'בטל מימוש' : 'סמן כמומש';
      html+=`<tr>
        <td>${isoToDDMMYYYY(r.date)}</td>
        <td>${fmtILS(r.amount)}</td>
        <td>${status}</td>
        <td><button class="${r.redeemed?'warn':'primary'} btnToggle" data-id="${r.id}" data-state="${r.redeemed?1:0}" data-cid="${customerId}">${label}</button></td>
      </tr>`;
    });
    html+='</tbody></table>';

    $('#couponTable').innerHTML=html;
    $('#custCard').style.display='block';

    // האזנה באמצעות האצלת אירועים (לטובת רענון עתידי)
    $('#couponTable').addEventListener('click', (ev)=>{
      const b = ev.target.closest('.btnToggle');
      if(!b) return;
      toggleRedeemed(parseInt(b.dataset.id,10), b.dataset.state==='1', b.dataset.cid);
    }, { once:false });

  }catch(e){ alert('שגיאה: '+safeMsg(e)); }
}

/* ===== סימון/ביטול מימוש (ביטול עם שם בעברית) ===== */
async function toggleRedeemed(couponId, currentlyRedeemed, customerId){
  try{
    if(currentlyRedeemed){
      const name = prompt('בטוח לבטל מימוש?\nהכנס/י שם מבטל (בעברית):');
      if(!name) return;
      if(!/[\u0590-\u05FF]/.test(name)){ alert('נא להזין שם בעברית.'); return; }
      // אפשר להוסיף לוג אירועים אם תרצה
    }
    const patch = currentlyRedeemed
      ? { redeemed:false, redeemed_at:null }
      : { redeemed:true,  redeemed_at:new Date().toISOString() };
    const { error } = await supabase.from('coupons').update(patch).eq('id', couponId);
    if(error){ alert('שגיאת עדכון: '+safeMsg(error)); return; }

    // רענון כרטיס
    const cust = customersCache.find(c=> String(c.customer_id)===String(customerId));
    openCustomer(customerId, cust?.name);
  }catch(e){ alert('שגיאה: '+safeMsg(e)); }
}
</script>
</body>
</html>
