<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ניהול שוברים — תצוגה ומימוש</title>
<script>
(function loadSupabase(){
  const urls=[
    "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"
  ];
  (function tryNext(i){
    if(i>=urls.length){document.dispatchEvent(new Event("supabase-ready"));return;}
    const s=document.createElement("script");s.src=urls[i];s.async=true;
    s.onload=()=>document.dispatchEvent(new Event("supabase-ready"));
    s.onerror=()=>tryNext(i+1);document.head.appendChild(s);
  })(0);
})();
</script>
<style>
:root{--bg:#0b111b;--card:#101826;--muted:#9fb3c8;--text:#e6edf6;--green:#22c55e;--red:#ef4444}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Heebo,Arial}
header{position:sticky;top:0;background:#0b111bcc;padding:12px 16px;border-bottom:1px solid #1f2a3a}
.container{max-width:1000px;margin:20px auto;padding:0 16px}
.card{background:#101826;border:1px solid #1f2a3a;border-radius:14px;padding:14px;margin-bottom:12px}
label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a52;background:#0b111b;color:var(--text)}
button{cursor:pointer} button.primary{background:#11623a} button.warn{background:#6b1a1a}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #263246;text-align:right}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a52;font-size:12px}
.ok{color:var(--green)} .bad{color:var(--red)}
</style>
</head>
<body>
<header><div class="container"><b>תצוגת שוברים</b> — חיפוש לקוח, מימוש/ביטול</div></header>
<div class="container">

  <div class="card">
    <div class="row">
      <div class="col"><label>Supabase URL</label><input id="sbUrl"/></div>
      <div class="col"><label>Supabase anon key</label><input id="sbKey"/></div>
    </div>
    <div id="connStatus" class="hint">מחבר…</div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col"><label>חיפוש לקוח</label><input id="search" placeholder="הקלד שם לקוח…"/></div>
      <div class="col"><label>בחר לקוח</label><select id="customerSelect"></select></div>
      <div class="col" style="flex:0 0 200px;align-self:end"><button id="btnOpen">פתח</button></div>
    </div>
    <div id="balances" style="margin-top:10px"></div>
  </div>

  <div class="card" id="custCard" style="display:none">
    <div class="row">
      <div class="col"><b id="custTitle">לקוח</b></div>
      <div class="col" style="flex:0 0 200px;align-self:end"><button id="btnBack">חזרה</button></div>
    </div>
    <div id="couponTable" style="margin-top:10px"></div>
  </div>

</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmtILS(n){ return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0)); }
function safeMsg(e){return (e&&(e.message||e.statusText||e.name))||String(e||'Unknown');}

const DEFAULT_URL="https://ylqpxwgchwalcblfipsu.supabase.co";
const DEFAULT_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";
let supabase=null;

async function init(){
  $('#sbUrl').value=localStorage.getItem('sb_url')||DEFAULT_URL;
  $('#sbKey').value=localStorage.getItem('sb_key')||DEFAULT_KEY;
  if(!window.supabase){$('#connStatus').textContent='ספריית Supabase לא נטענה';return;}
  supabase=window.supabase.createClient($('#sbUrl').value.trim(), $('#sbKey').value.trim());
  localStorage.setItem('sb_url',$('#sbUrl').value.trim());
  localStorage.setItem('sb_key',$('#sbKey').value.trim());
  const {error}=await supabase.auth.getSession();
  $('#connStatus').textContent = error?('שגיאה: '+error.message):'מחובר ל-Supabase';
  loadBalances();
}
document.addEventListener('supabase-ready', init);
['change','blur'].forEach(e=>{$('#sbUrl').addEventListener(e, init);$('#sbKey').addEventListener(e, init);});

async function loadBalances(){
  try{
    const { data, error } = await supabase.from('customer_balances').select('*').order('name');
    if(error){ $('#balances').innerHTML='<span class="bad">שגיאה: '+safeMsg(error)+'</span>'; return; }
    // טבלת סיכומים
    let html='<table><thead><tr><th>לקוח</th><th>סה״כ נטען</th><th>סה״כ מומש</th><th>זמין</th></tr></thead><tbody>';
    (data||[]).forEach(r=>{ html+=`<tr><td>${r.name}</td><td>${fmtILS(r.total_loaded)}</td><td>${fmtILS(r.total_redeemed)}</td><td><b>${fmtILS(r.available_amount)}</b></td></tr>`; });
    html+='</tbody></table>'; $('#balances').innerHTML=html;

    // מילוי select + חיפוש
    const sel=$('#customerSelect'); sel.innerHTML='';
    (data||[]).forEach(r=> sel.add(new Option(r.name, r.customer_id)));
    $('#search').addEventListener('input', ()=>{
      const q=$('#search').value.toLowerCase();
      sel.innerHTML='';
      (data||[]).filter(r=> r.name.toLowerCase().includes(q)).forEach(r=> sel.add(new Option(r.name, r.customer_id)));
    });
  }catch(e){ $('#balances').innerHTML='<span class="bad">שגיאה: '+safeMsg(e)+'</span>'; }
}
$('#btnOpen').addEventListener('click', ()=> openCustomer($('#customerSelect').value));
$('#btnBack').addEventListener('click', ()=> $('#custCard').style.display='none');

async function openCustomer(customerId){
  if(!customerId){ alert('בחר לקוח'); return; }
  try{
    const { data: cust, error: ce } = await supabase.from('customers').select('customer_id,name').eq('customer_id', customerId).single();
    if(ce){ alert('שגיאה: '+safeMsg(ce)); return; }
    $('#custTitle').textContent='לקוח: '+cust.name;

    const { data: rows, error } = await supabase.from('coupons')
      .select('id,date,amount,redeemed,redeemed_at')
      .eq('customer_id', customerId).order('date',{ascending:false});
    if(error){ alert('שגיאת קריאה: '+safeMsg(error)); return; }

    // טבלת שוברים + כפתור החלפת מצב (מימוש/ביטול)
    let html='<table><thead><tr><th>תאריך</th><th>סכום</th><th>סטטוס</th><th>פעולה</th></tr></thead><tbody>';
    (rows||[]).forEach(r=>{
      const status = r.redeemed ? `✔️ <span class="badge">${r.redeemed_at? new Date(r.redeemed_at).toLocaleString('he-IL'):''}</span>` : '';
      const label  = r.redeemed ? 'בטל מימוש' : 'סמן כמומש';
      html+=`<tr>
        <td>${r.date}</td>
        <td>${fmtILS(r.amount)}</td>
        <td>${status}</td>
        <td><button class="${r.redeemed?'warn':''} btnToggle" data-id="${r.id}" data-state="${r.redeemed?1:0}">${label}</button></td>
      </tr>`;
    });
    html+='</tbody></table>';
    // הוספת שובר ידני
    html+=`
      <div class="row" style="margin-top:12px">
        <div class="col"><label>תאריך</label><input id="manualDate" placeholder="YYYY-MM-DD"/></div>
        <div class="col"><label>סכום</label><input id="manualAmount" type="number" step="0.01" value="22"/></div>
        <div class="col" style="flex:0 0 200px;align-self:end"><button id="btnAdd" class="primary">הוסף שובר</button></div>
      </div>`;
    $('#couponTable').innerHTML=html;
    $('#custCard').style.display='block';

    $$('.btnToggle').forEach(b=> b.addEventListener('click', ()=> toggleRedeemed(parseInt(b.dataset.id,10), b.dataset.state==='1')));
    $('#btnAdd').addEventListener('click', async ()=>{
      const date = ($('#manualDate').value||'').trim();
      const amount = parseFloat($('#manualAmount').value||'0');
      if(!date){ alert('נא להקליד תאריך'); return; }
      const { error: upErr } = await supabase.from('coupons').upsert(
        { customer_id: customerId, date, amount, redeemed:false, source_label:'manual' },
        { onConflict:'customer_id,date' }
      );
      if(upErr){ alert('שגיאה בהוספה: '+safeMsg(upErr)); return; }
      openCustomer(customerId); loadBalances();
    });

  }catch(e){ alert('שגיאה: '+safeMsg(e)); }
}

async function toggleRedeemed(couponId, current){
  try{
    const patch = current ? { redeemed:false, redeemed_at:null } : { redeemed:true, redeemed_at:new Date().toISOString() };
    const { error } = await supabase.from('coupons').update(patch).eq('id', couponId);
    if(error){ alert('שגיאת עדכון: '+safeMsg(error)); return; }
    // רענון מהיר: לוקחים את הלקוח הנוכחי מהכותרת
    const name = $('#custTitle').textContent.replace('לקוח: ','').trim();
    const { data: cust } = await supabase.from('customers').select('customer_id').eq('name', name).single();
    if(cust){ openCustomer(cust.customer_id); loadBalances(); }
  }catch(e){ alert('שגיאה: '+safeMsg(e)); }
}
</script>
</body>
</html>
