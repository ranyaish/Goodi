<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>גודי שוברים - מערכת ניהול</title>

<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
body{margin:0;background:#fff;color:#0f172a;font-family:system-ui,Heebo,Arial}
header{display:flex;align-items:center;gap:12px;position:sticky;top:0;background:#fff;padding:12px 16px;border-bottom:1px solid #e5e7eb;z-index:10}
header img{height:40px}
.container{max-width:860px;margin:20px auto;padding:0 16px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin-bottom:12px}
button{cursor:pointer;padding:8px 12px;border-radius:8px;border:1px solid #e5e7eb;background:#fff}
button.primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
button.small{padding:6px 10px;font-size:13px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:right}
thead th{background:#f9fafb;position:sticky;top:64px}
.badge{padding:2px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="לוגו"/> <!-- כאן תשמור את הקובץ בשם logo.png באותה תיקייה -->
  <h2 style="margin:0">גודי שוברים - מערכת ניהול</h2>
  <div style="flex:1"></div>
  <button id="btnLogout" class="small">יציאה</button>
</header>

<div class="container">

  <div class="card">
    <div style="margin-bottom:10px">
      <button id="btnPick" class="primary">בחר לקוח</button>
    </div>
    <label>לקוח נוכחי</label>
    <input id="currentCustomer" disabled placeholder="לא נבחר"/>
    <div id="connStatus" style="margin-top:8px;font-size:13px;color:#666">מחבר…</div>
  </div>

  <div class="card" id="custCard" style="display:none">
    <h3 id="custTitle">לקוח</h3>
    <div id="couponTable"></div>
  </div>

</div>

<!-- מודאל בחירת לקוח -->
<div id="modalPick" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:14px;max-width:460px;width:90%;padding:14px">
    <h3>בחר לקוח</h3>
    <input id="searchInput" placeholder="חפש…" style="width:100%;margin-bottom:10px;padding:8px;border:1px solid #e5e7eb;border-radius:8px"/>
    <div id="listWrap" style="max-height:360px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px"></div>
    <div style="text-align:left;margin-top:8px"><button id="btnCloseModal">סגור</button></div>
  </div>
</div>

<script>
const DEFAULT_URL="https://ylqpxwgchwalcblfipsu.supabase.co";
const DEFAULT_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";

let supabase=null, customersCache=[];

function fmtILS(n){return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0));}
function isoToDDMMYYYY(iso){ if(!iso) return ''; const [y,m,d]=String(iso).split('-'); return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;}

async function init(){
  supabase = window.supabase.createClient(DEFAULT_URL, DEFAULT_KEY);
  $('#connStatus').textContent='מחובר ל-Supabase';
  await loadCustomers();
}
document.addEventListener("DOMContentLoaded", init);

async function loadCustomers(){
  const { data, error } = await supabase.from('customers').select('customer_id,name').order('name');
  if(error){$('#connStatus').textContent='שגיאה: '+error.message;return;}
  customersCache=data||[];
  $('#connStatus').textContent='נטענו '+customersCache.length+' לקוחות';
}

function renderList(list){
  const el=$('#listWrap');
  if(!list.length){el.innerHTML='<div style="padding:10px;color:#666">לא נמצאו</div>';return;}
  el.innerHTML=list.map(c=>`<button style="display:block;width:100%;padding:8px;border:0;border-bottom:1px solid #eee;background:#fff;text-align:right" data-id="${c.customer_id}" data-name="${c.name}">${c.name}</button>`).join('');
}

$('#btnPick').onclick=()=>{ $('#modalPick').style.display='flex'; renderList(customersCache); }
$('#btnCloseModal').onclick=()=>$('#modalPick').style.display='none';
$('#searchInput').oninput=()=>{
  const q=$('#searchInput').value.toLowerCase();
  const list=customersCache.filter(c=>c.name.toLowerCase().includes(q));
  renderList(list);
}
$('#listWrap').onclick=ev=>{
  const btn=ev.target.closest('button[data-id]');
  if(!btn)return;
  $('#currentCustomer').value=btn.dataset.name;
  $('#modalPick').style.display='none';
  openCustomer(btn.dataset.name);
}
$('#btnLogout').onclick=()=>{ location.reload(); }

async function openCustomer(name){
  $('#custTitle').textContent='לקוח: '+name;
  const { data, error } = await supabase.from('coupons').select('*').eq('name', name).order('date',{ascending:false});
  if(error){alert('שגיאה: '+error.message);return;}
  let html='<table><thead><tr><th>תאריך</th><th>סכום</th><th>סטטוס</th></tr></thead><tbody>';
  (data||[]).forEach(r=>{
    html+=`<tr><td>${isoToDDMMYYYY(r.date)}</td><td>${fmtILS(r.amount)}</td><td>${r.redeemed?'✔️':'❌'}</td></tr>`;
  });
  html+='</tbody></table>';
  $('#couponTable').innerHTML=html;
  $('#custCard').style.display='block';
}

function $(s){return document.querySelector(s);}
</script>
</body>
</html>
