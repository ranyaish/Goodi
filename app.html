<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>טרמינל שוברים — מימוש/ביטול</title>

<!-- supabase-js עם Fallback -->
<script>
(function loadSupabase(){
  const urls=[
    "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js"
  ];
  (function go(i){
    if(i>=urls.length){document.dispatchEvent(new Event("supabase-ready"));return;}
    const s=document.createElement("script");s.src=urls[i];s.async=true;
    s.onload=()=>document.dispatchEvent(new Event("supabase-ready"));
    s.onerror=()=>go(i+1);document.head.appendChild(s);
  })(0);
})();
</script>

<style>
:root{
  --bg:#ffffff; --card:#ffffff; --muted:#5b6b7a; --text:#0f172a; --line:#e5e7eb;
  --blue:#0ea5e9; --red:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Heebo,Arial}
header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);
  padding:12px 16px;border-bottom:1px solid var(--line)}
.container{max-width:820px;margin:20px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
input,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text)}
button{cursor:pointer}
button.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
button.warn{background:var(--red);color:#fff;border-color:var(--red)}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--line);text-align:right}
thead th{position:sticky;top:64px;background:#fff}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.hint{color:var(--muted);font-size:13px}
.suggestions{position:relative}
.suggestions-list{
  position:absolute;z-index:10;right:0;left:0;background:#fff;border:1px solid var(--line);border-radius:10px;
  max-height:220px;overflow:auto;display:none
}
.suggestions-list button{
  display:block;width:100%;text-align:right;border:0;border-bottom:1px solid var(--line);background:#fff;padding:8px 10px
}
.suggestions-list button:last-child{border-bottom:0}
</style>
</head>
<body>
<header><div class="container"><b>טרמינל שוברים</b> — בחירת לקוח, מימוש/ביטול</div></header>
<div class="container">

  <!-- חיבור -->
  <div class="card">
    <div class="row">
      <div class="col"><label>Supabase URL</label><input id="sbUrl"/></div>
      <div class="col"><label>Supabase anon key</label><input id="sbKey"/></div>
    </div>
    <div id="connStatus" class="hint">מחבר…</div>
  </div>

  <!-- חיפוש לקוח (ללא רשימה פתוחה) -->
  <div class="card">
    <div class="row">
      <div class="col suggestions">
        <label>חיפוש לקוח</label>
        <input id="search" placeholder="הקלד שם לקוח…"/>
        <div id="sugList" class="suggestions-list"></div>
      </div>
      <div class="col" style="flex:0 0 200px;align-self:end">
        <button id="btnOpen" class="primary">פתח</button>
      </div>
    </div>
  </div>

  <!-- פרטי לקוח (רק שוברים, ללא סיכומי על) -->
  <div class="card" id="custCard" style="display:none">
    <div class="row">
      <div class="col"><b id="custTitle">לקוח</b></div>
      <div class="col" style="flex:0 0 200px;align-self:end"><button id="btnBack">חזרה</button></div>
    </div>
    <div id="couponTable" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* ===== Utils ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmtILS(n){ return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0)); }
function safeMsg(e){return (e&&(e.message||e.statusText||e.name))||String(e||'Unknown');}
function isoToDDMMYYYY(iso){ if(!iso) return ''; const [y,m,d]=String(iso).split('-'); if(!y||!m||!d) return iso; return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`; }

/* ===== Supabase ===== */
const DEFAULT_URL="https://ylqpxwgchwalcblfipsu.supabase.co";
const DEFAULT_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";
let supabase=null, balancesCache=[];

async function init(){
  $('#sbUrl').value=localStorage.getItem('sb_url')||DEFAULT_URL;
  $('#sbKey').value=localStorage.getItem('sb_key')||DEFAULT_KEY;
  if(!window.supabase){$('#connStatus').textContent='ספריית Supabase לא נטענה';return;}
  supabase=window.supabase.createClient($('#sbUrl').value.trim(), $('#sbKey').value.trim());
  localStorage.setItem('sb_url',$('#sbUrl').value.trim());
  localStorage.setItem('sb_key',$('#sbKey').value.trim());
  const {error}=await supabase.auth.getSession();
  $('#connStatus').textContent = error?('שגיאה: '+error.message):'מחובר ל-Supabase';
  await cacheCustomerNames();
  setupSearch();
}
document.addEventListener('supabase-ready', init);
['change','blur'].forEach(e=>{$('#sbUrl').addEventListener(e, init);$('#sbKey').addEventListener(e, init);});

/* ===== חיפוש (ללא רשימה פתוחה) ===== */
async function cacheCustomerNames(){
  // נביא שמות לקוחות לצורך הצעות חיפוש
  const { data, error } = await supabase.from('customers').select('customer_id,name').order('name');
  if(error){ console.warn('שגיאה בטעינת לקוחות', error); balancesCache=[]; return; }
  balancesCache = data||[];
}
function setupSearch(){
  const input=$('#search'), list=$('#sugList');
  function hide(){ list.style.display='none'; list.innerHTML=''; }
  function show(items){
    if(!items.length){ hide(); return; }
    list.innerHTML = items.map(it=>`<button type="button" data-cid="${it.customer_id}" data-name="${it.name}">${it.name}</button>`).join('');
    list.style.display='block';
    $$('#sugList button').forEach(b=> b.addEventListener('click', ()=>{
      input.value = b.dataset.name;
      input.dataset.cid = b.dataset.cid;
      hide();
    }));
  }
  input.addEventListener('input', ()=>{
    const q=input.value.toLowerCase().trim();
    if(!q){ hide(); input.dataset.cid=''; return; }
    const matches = balancesCache.filter(r=> r.name.toLowerCase().includes(q)).slice(0,20);
    show(matches);
  });
  input.addEventListener('blur', ()=> setTimeout(hide, 150));
  $('#btnOpen').addEventListener('click', ()=>{
    const cid = input.dataset.cid;
    if(!cid){ alert('בחר לקוח מהרשימה המוצעת (הקלד והקלק על שם הלקוח)'); return; }
    openCustomer(cid);
  });
}
$('#btnBack').addEventListener('click', ()=> $('#custCard').style.display='none');

/* ===== פרטי לקוח (רק רשימת שוברים) ===== */
async function openCustomer(customerId){
  try{
    const { data: cust, error: ce } = await supabase.from('customers').select('customer_id,name').eq('customer_id', customerId).single();
    if(ce){ alert('שגיאה: '+safeMsg(ce)); return; }
    $('#custTitle').textContent='לקוח: '+cust.name;

    const { data: rows, error } = await supabase.from('coupons')
      .select('id,date,amount,redeemed,redeemed_at')
      .eq('customer_id', customerId).order('date',{ascending:false});
    if(error){ alert('שגיאת קריאה: '+safeMsg(error)); return; }

    let html='<table><thead><tr><th>תאריך</th><th>סכום</th><th>סטטוס</th><th>פעולה</th></tr></thead><tbody>';
    (rows||[]).forEach(r=>{
      const status = r.redeemed ? `✔️ <span class="badge">${r.redeemed_at? new Date(r.redeemed_at).toLocaleString('he-IL'):''}</span>` : '';
      const label  = r.redeemed ? 'בטל מימוש' : 'סמן כמומש';
      html+=`<tr>
        <td>${isoToDDMMYYYY(r.date)}</td>
        <td>${fmtILS(r.amount)}</td>
        <td>${status}</td>
        <td><button class="${r.redeemed?'warn':'primary'} btnToggle" data-id="${r.id}" data-state="${r.redeemed?1:0}">${label}</button></td>
      </tr>`;
    });
    html+='</tbody></table>';

    $('#couponTable').innerHTML=html;
    $('#custCard').style.display='block';

    $$('.btnToggle').forEach(b=> b.addEventListener('click', ()=> toggleRedeemed(parseInt(b.dataset.id,10), b.dataset.state==='1', customerId)));
  }catch(e){ alert('שגיאה: '+safeMsg(e)); }
}

/* ===== סימון/ביטול מימוש ===== */
async function toggleRedeemed(couponId, currentlyRedeemed, customerId){
  try{
    if(currentlyRedeemed){
      // בקש שם מבטל — חייב לכלול עברית (כל טקסט בעברית לגיטימי)
      const name = prompt('הכנס/י שם מבטל המימוש (בעברית):');
      if(!name){ return; } // ביטול ע"י המשתמש
      const hebrew = /[\u0590-\u05FF]/.test(name);
      if(!hebrew){ alert('נא להזין שם בעברית.'); return; }
      // לא שומרים איפשהו — משמש רק לאישור.
    }
    const patch = currentlyRedeemed
      ? { redeemed:false, redeemed_at:null }
      : { redeemed:true,  redeemed_at:new Date().toISOString() };
    const { error } = await supabase.from('coupons').update(patch).eq('id', couponId);
    if(error){ alert('שגיאת עדכון: '+safeMsg(error)); return; }
    openCustomer(customerId);
  }catch(e){ alert('שגיאה: '+safeMsg(e)); }
}
</script>
</body>
</html>
