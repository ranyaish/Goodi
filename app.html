<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>גודי שוברים - מערכת ניהול (v14)</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root{--border:#e5e7eb;--muted:#64748b;--brand:#0ea5e9;--text:#0f172a;--bg:#fff;--card:#fff}
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,Heebo,Arial,sans-serif;margin:0}
    .container{max-width:940px;margin:20px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header img{width:48px;height:48px;border-radius:8px;object-fit:cover}
    h1{margin:0;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
    .col{flex:1 1 240px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button{border:1px solid var(--border);border-radius:10px;padding:10px 14px;background:var(--brand);color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:var(--text)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .section-title{font-size:18px;margin:0 0 10px}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#f8fafc}
    .empty{color:var(--muted);text-align:center;padding:28px;border:1px dashed var(--border);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right}
    thead tr{background:#f1f5f9}
    /* Tabs */
    .tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer}
    .tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    /* Stats */
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    .stat{flex:1 1 160px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .stat .k{color:var(--muted);font-size:12px}
    .stat .v{font-size:18px;font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo.png" alt="לוגו" />
      <div>
        <h1>גודי שוברים - מערכת ניהול</h1>
        <div class="muted">ניהול Goodi + שוברים תאגידיים (תן-ביס/סיבוס)</div>
      </div>
      <div style="margin-inline-start:auto;display:flex;gap:8px;align-items:center">
        <span class="pill">v14</span>
        <button id="logout" class="ghost">יציאה</button>
      </div>
    </header>

    <!-- התחברות מקומית (לא סיסמת Supabase) -->
    <section id="login-card" class="card" style="display:none">
      <h2 class="section-title">כניסה</h2>
      <div class="row">
        <div class="col">
          <label>שם משתמש</label>
          <input id="login-user" autocomplete="username" value="admin" />
        </div>
        <div class="col">
          <label>סיסמה</label>
          <input id="login-pass" type="password" autocomplete="current-password" value="1234" />
        </div>
        <div class="col" style="align-self:end">
          <button id="login-btn">התחבר</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">* אימות לוקלי בלבד.</div>
    </section>

    <!-- טאבים -->
    <div id="app-wrap" style="display:none">
      <div class="tabs">
        <button class="tab active" data-tab="goodi">לקוחות גודי</button>
        <button class="tab" data-tab="corp">לקוחות תאגידיים (תן-ביס/סיבוס)</button>
      </div>

      <!-- TAB: Goodi -->
      <section id="tab-goodi" class="card">
        <h2 class="section-title">לקוחות גודי</h2>
        <div class="row" style="align-items:center">
          <button id="pickCustomer" style="min-width:140px">בחר לקוח</button>
          <div class="col" style="flex:1">
            <div class="muted">לקוח נוכחי</div>
            <div id="customerName" class="pill" style="min-height:34px;display:inline-flex;align-items:center">לא נבחר</div>
          </div>
        </div>
        <div id="coupons-area" style="margin-top:12px">
          <div class="empty">לא נבחר לקוח.</div>
        </div>
      </section>

      <!-- TAB: Corp (תן-ביס/סיבוס) -->
      <section id="tab-corp" class="card" style="display:none">
        <h2 class="section-title">לקוחות תאגידיים (תן-ביס/סיבוס)</h2>

        <div class="row">
          <div class="col">
            <label>שם לקוח</label>
            <input id="m_name" placeholder="לדוגמה: יוסי כהן"/>
          </div>
          <div class="col">
            <label>סכום טעינה (₪)</label>
            <input id="m_amount" type="number" step="0.01" min="0" placeholder="לדוגמה: 150"/>
          </div>
          <div class="col">
            <label>תאריך טעינה</label>
            <input id="m_opened" type="date"/>
          </div>
          <div class="col" style="align-self:end">
            <button id="m_create">צור שובר</button>
          </div>
        </div>

        <!-- סיכומי לקוח תאגידי -->
        <div id="m_totals_wrap" class="stats" style="display:none">
          <div class="stat">
            <div class="k">סה״כ נטען</div>
            <div id="m_total_initial" class="v">₪ 0.00</div>
          </div>
          <div class="stat">
            <div class="k">סה״כ מומש</div>
            <div id="m_total_redeemed" class="v">₪ 0.00</div>
          </div>
          <div class="stat">
            <div class="k">יתרה שלא מומשה</div>
            <div id="m_total_remaining" class="v">₪ 0.00</div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0"/>

        <div class="row">
          <div class="col">
            <label>שוברים פתוחים ללקוח</label>
            <select id="m_vouchers"></select>
          </div>
          <div class="col">
            <label>מימוש (₪)</label>
            <input id="m_redeem_amount" type="number" step="0.01" min="0" placeholder="לדוגמה: 40"/>
          </div>
          <div class="col">
            <label>תאריך מימוש</label>
            <input id="m_redeem_at" type="datetime-local"/>
          </div>
          <div class="col">
            <label>שם מאשר/הערה</label>
            <input id="m_by" placeholder="לדוגמה: רן / הערה"/>
          </div>
          <div class="col" style="align-self:end">
            <button id="m_redeem">הוסף מימוש</button>
          </div>
        </div>

        <div id="m_list" style="margin-top:12px"></div>
      </section>
    </div>

    <!-- Debug קצר -->
    <section id="debug-box" class="card" style="margin-top:12px">
      <div class="row" style="align-items:center;gap:8px">
        <div class="pill">גרסה v14</div>
        <div id="ts-pill" class="pill"></div>
        <div id="dbg-msg" class="muted"></div>
      </div>
    </section>
  </div>

  <!-- Supabase client (כמו אצלך) -->
  <script type="module" src="./supabaseClient.js?v=14"></script>

  <script type="module">
    /********* התחברות לוקאלית *********/
    const LOCAL_USER='admin', LOCAL_PASS='1234', AUTH_KEY='goodi-authed';
    const $ = s=>document.querySelector(s);
    const ts = ()=> new Date().toLocaleString('he-IL',{hour12:false});
    $('#ts-pill').textContent = ts();

    import { supabase } from './supabaseClient.js';

    function setAuthUI(){
      const ok = localStorage.getItem(AUTH_KEY)==='1';
      $('#login-card').style.display = ok ? 'none' : '';
      $('#app-wrap').style.display   = ok ? '' : 'none';
      $('#logout').style.display     = ok ? '' : 'none';
      $('#dbg-msg').textContent = ok ? 'מחובר' : 'ממתין להתחברות';
      if(ok){ loadCustomersCount(); }
    }

    $('#login-btn')?.addEventListener('click', ()=>{
      const u=$('#login-user').value.trim(), p=$('#login-pass').value.trim();
      if(u===LOCAL_USER && p===LOCAL_PASS){ localStorage.setItem(AUTH_KEY,'1'); setAuthUI(); }
      else alert('שם משתמש/סיסמה שגויים');
    });
    $('#logout').addEventListener('click', ()=>{
      localStorage.removeItem(AUTH_KEY);
      location.reload();
    });

    /********* Tabs *********/
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        $('#tab-goodi').style.display = (tab==='goodi') ? '' : 'none';
        $('#tab-corp').style.display  = (tab==='corp')  ? '' : 'none';
      });
    });

    /********* GOODI – בחירת לקוח + טבלת שוברים *********/
    const nameBox=$('#customerName'), area=$('#coupons-area');
    $('#pickCustomer').addEventListener('click', async ()=>{
      try{
        const { data, error } = await supabase.from('customers').select('customer_id,name').order('name');
        if(error) throw error;
        if(!data?.length){ alert('אין לקוחות.'); return; }
        const name = prompt('בחר/הקלד בדיוק שם לקוח מתוך הרשימה:\n\n'+data.map(r=>r.name).join('\n'));
        const c = data.find(r=>r.name===name);
        if(!c) return;
        nameBox.textContent = c.name;
        await showCustomerCoupons(c.customer_id, c.name);
      }catch(e){ alert('שגיאה בטעינת לקוחות'); }
    });

    async function showCustomerCoupons(customerId, customerName){
      area.innerHTML = '<div class="muted">טוען…</div>';
      const { data, error } = await supabase
        .from('coupons')
        .select('id,date,amount,redeemed,redeemed_at,source_label')
        .eq('customer_id', customerId)
        .order('date',{ascending:false})
        .limit(200);
      if(error){ area.innerHTML=`<div class="empty">שגיאה: ${error.message}</div>`; return; }
      if(!data?.length){ area.innerHTML=`<div class="empty">אין שוברים ל<strong>${customerName}</strong>.</div>`; return; }

      const fmt=(d)=> new Date(d).toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'});
      const rows = data.map(r=>`
        <tr>
          <td>${fmt(r.date)}</td>
          <td>₪ ${Number(r.amount).toFixed(2)}</td>
          <td>${r.redeemed?'מומש':'פתוח'}</td>
          <td>${r.redeemed_at?new Date(r.redeemed_at).toLocaleString('he-IL'):'—'}</td>
          <td>${r.source_label??''}</td>
          <td>
            ${r.redeemed
              ? `<button class="ghost" data-act="undo" data-id="${r.id}">בטל מימוש</button>`
              : `<button data-act="do" data-id="${r.id}">סמן כמומש</button>`}
          </td>
        </tr>
      `).join('');
      area.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>כרטיס לקוח:</strong> ${customerName}</div>
          <div class="muted">סה"כ ${data.length} שוברים</div>
        </div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr><th>תאריך</th><th>סכום</th><th>סטטוס</th><th>מומש בתאריך</th><th>מקור</th><th>פעולה</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
      area.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=Number(btn.dataset.id), act=btn.dataset.act;
          try{
            if(act==='do'){
              if(!confirm('לאשר מימוש שובר?')) return;
              const { error } = await supabase.from('coupons').update({redeemed:true,redeemed_at:new Date().toISOString()}).eq('id',id);
              if(error) throw error;
            }else{
              const approver = prompt('שם מבטל המימוש:'); if(!approver) return;
              const { error } = await supabase.from('coupons').update({redeemed:false,redeemed_at:null,source_label:approver}).eq('id',id);
              if(error) throw error;
            }
            await showCustomerCoupons(customerId, customerName);
          }catch(e){ alert('שגיאה: '+e.message); }
        });
      });
    }

    async function loadCustomersCount(){
      try{
        const { count, error } = await supabase.from('customers').select('customer_id',{count:'exact',head:true});
        if(error) throw error;
        $('#dbg-msg').textContent = `מחובר • לקוחות Goodi: ${count??0}`;
      }catch{ /* ignore */ }
    }

    /********* CORP – תן-ביס/סיבוס (נפרד לחלוטין) *********/
    const fmtILS = v => `₪ ${Number(v||0).toFixed(2)}`;
    const toISODate = (d)=> (d?new Date(d):new Date()).toISOString().slice(0,10);
    const toISODtLocal = (d)=>{
      const x=d?new Date(d):new Date(); const pad=n=>String(n).padStart(2,'0');
      return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}T${pad(x.getHours())}:${pad(x.getMinutes())}`;
    };
    $('#m_opened').value = toISODate();
    $('#m_redeem_at').value = toISODtLocal();

    async function corpGetOrCreateCustomer(name){
      const { data, error } = await supabase.rpc('corp_get_or_create_customer', { p_name: name });
      if(error) throw error;
      return data; // corp_customer_id
    }

    async function corpRefresh(name){
      if(!name){ 
        $('#m_vouchers').innerHTML='';
        $('#m_list').innerHTML='<div class="empty">הכנס שם לקוח.</div>';
        $('#m_totals_wrap').style.display='none';
        return; 
      }
      try{
        const cid = await corpGetOrCreateCustomer(name); // יוצר אם חסר

        // 1) סיכומי לקוח (סה"כ / מומש / יתרה)
        const { data: totals, error: tErr } = await supabase
          .from('corp_customer_balances_view')
          .select('initial_total,redeemed_total,remaining_total')
          .eq('corp_customer_id', cid)
          .single();
        if(tErr && tErr.code!=='PGRST116'){ throw tErr; } // PGRST116 = no rows
        const init = totals?.initial_total ?? 0;
        const red  = totals?.redeemed_total ?? 0;
        const rem  = totals?.remaining_total ?? 0;
        $('#m_total_initial').textContent = fmtILS(init);
        $('#m_total_redeemed').textContent = fmtILS(red);
        $('#m_total_remaining').textContent = fmtILS(rem);
        $('#m_totals_wrap').style.display = 'flex';

        // 2) פירוט שוברים + Dropdown פתוחים
        const { data, error } = await supabase
          .from('corp_balances_view')
          .select('*')
          .eq('corp_customer_id', cid)
          .order('opened_at', { ascending:false });
        if(error) throw error;

        const open = data.filter(x=>Number(x.remaining_amount)>0);
        $('#m_vouchers').innerHTML = open.length
          ? open.map(v=>`<option value="${v.voucher_id}">#${v.voucher_id} • ${v.opened_at} • יתרה ${fmtILS(v.remaining_amount)}</option>`).join('')
          : `<option value="">אין שוברים פתוחים</option>`;

        const rows = data.map(v=>`
          <tr>
            <td>${v.voucher_id}</td>
            <td>${v.customer_name}</td>
            <td>${v.opened_at}</td>
            <td>${fmtILS(v.initial_amount)}</td>
            <td>${fmtILS(v.redeemed_sum)}</td>
            <td><strong>${fmtILS(v.remaining_amount)}</strong></td>
            <td>${v.note??''}</td>
          </tr>
        `).join('');
        $('#m_list').innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>#</th><th>לקוח</th><th>תאריך טעינה</th><th>סכום פתיחה</th><th>נצבר מומש</th><th>יתרה</th><th>הערה</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }catch(e){
        alert('שגיאה בטעינת נתוני תאגיד: '+e.message);
      }
    }

    // יצירת שובר תאגידי
    $('#m_create').addEventListener('click', async ()=>{
      const name=$('#m_name').value.trim();
      const amount=Number($('#m_amount').value);
      const opened=$('#m_opened').value;
      if(!name || !amount || amount<=0 || !opened){ alert('שם לקוח, סכום ותאריך טעינה נדרשים'); return; }
      try{
        const cid = await corpGetOrCreateCustomer(name);
        const { error } = await supabase.from('corp_vouchers').insert({
          corp_customer_id: cid,
          opened_at: opened,
          initial_amount: amount,
          note: 'corp_manual'
        });
        if(error) throw error;
        await corpRefresh(name);
        alert('שובר נוצר');
      }catch(e){ alert('שגיאה ביצירת שובר: '+e.message); }
    });

    // הוספת מימוש תאגידי (אין ביטול מימוש כאן)
    $('#m_redeem').addEventListener('click', async ()=>{
      const name=$('#m_name').value.trim();
      const vid = Number($('#m_vouchers').value);
      const amt = Number($('#m_redeem_amount').value);
      const when=$('#m_redeem_at').value;
      const by  = $('#m_by').value.trim();
      if(!name || !vid || !amt || amt<=0 || !when){ alert('בחר שובר, סכום ותאריך מימוש'); return; }
      try{
        const { error } = await supabase.from('corp_redemptions').insert({
          voucher_id: vid,
          amount: amt,
          redeemed_at: new Date(when).toISOString(),
          by_user: by || null
        });
        if(error) throw error;
        await corpRefresh(name);
        alert('מימוש נוסף');
      }catch(e){ alert('שגיאה במימוש: '+e.message); }
    });

    // שינוי/עזיבת שדה השם -> רענון רשימת שוברים + סיכומים
    $('#m_name').addEventListener('change', ()=> corpRefresh($('#m_name').value.trim()));
    $('#m_name').addEventListener('blur',   ()=> corpRefresh($('#m_name').value.trim()));

    /********* INIT *********/
    setAuthUI();
  </script>
</body>
</html>
