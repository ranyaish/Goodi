<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>גודי שוברים — מערכת ניהול</title>

  <!-- Supabase bootstrap (נשען על supabaseClient.js שיש לך בריפו) -->
  <script src="./supabaseClient.js"></script>

  <style>
    :root { --muted:#6b7280; --border:#e5e7eb; --bg:#fff; --pill:#f1f5f9; }
    body{font-family:system-ui,Arial,Heebo,sans-serif;background:#fff;color:#111;margin:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:6px;object-fit:cover}
    h1{font-size:22px;margin:0}
    .wrap{max-width:920px;margin:20px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
    button{border:1px solid var(--border);background:#0ea5e9;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.small{padding:6px 10px;border-radius:8px;font-size:14px}
    button.ghost{background:#fff;color:#111}
    .muted{color:var(--muted);font-size:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .pill{font-size:12px;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:3px 8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-size:15px}
    thead th{background:#f8fafc}
    .tbl-note{font-size:13px;color:var(--muted)}
    .ok{color:#065f46}
    .bad{color:#991b1b}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(720px,92vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:14px}
    .modal .hdr{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .modal input[type="text"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .cust-list{max-height:50vh;overflow:auto;margin-top:10px;border:1px solid var(--border);border-radius:10px}
    .cust-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9}
    .cust-item:hover{background:#f8fafc}
    .actions{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>

  
  <!-- כותרת -->
  <header>
    <div class="brand">
      <img src="logo.png" alt="לוגו" />
      <h1>גודי שוברים — מערכת ניהול</h1>
    </div>
    <div class="row">
      <button id="logoutBtn" class="ghost">יציאה</button>
    </div>
  </header>
  
<!-- פס קומפקטי: ריצה אחרונה מגיטהאב (בלי "פתח לוג") -->
<div id="wf-mini" style="direction:rtl;max-width:920px;margin:16px auto 0;font-family:system-ui">
  <div style="font-size:13px;color:#6b7280;margin-bottom:6px">עדכון אחרון</div>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px">
    <span id="wf-mini-run" style="font-family:ui-monospace,Menlo,Consolas,monospace">—</span>
    <span id="wf-mini-status" style="border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;color:#6b7280">—</span>
    <span id="wf-mini-time" style="color:#6b7280">—</span>
  </div>
</div>

<script>
(async () => {
  const repo = 'ranyaish/Goodi';
  const url  = `https://api.github.com/repos/${repo}/actions/runs?per_page=1`;

  const runEl = document.getElementById('wf-mini-run');
  const stEl  = document.getElementById('wf-mini-status');
  const tEl   = document.getElementById('wf-mini-time');

  async function loadOne() {
    try {
      const r = await fetch(url, { headers:{'Accept':'application/vnd.github+json'}, cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      const js = await r.json();
      const x = js.workflow_runs?.[0];
      if(!x) throw new Error('אין ריצות');

      runEl.textContent = `run #${x.run_number}`;
      tEl.textContent   = new Date(x.created_at).toLocaleString('he-IL',{hour12:false});

      const s = (x.conclusion || x.status || '').toLowerCase();
      stEl.textContent = s || '—';
      stEl.style.background = s==='success' ? '#ecfdf5' : (s==='failure'||s==='cancelled' ? '#fef2f2' : '#f3f4f6');
      stEl.style.color      = s==='success' ? '#065f46' : (s==='failure'||s==='cancelled' ? '#991b1b' : '#374151');
      stEl.style.borderColor= s==='success' ? '#a7f3d0' : (s==='failure'||s==='cancelled' ? '#fecaca' : '#e5e7eb');
    } catch(e) {
      runEl.textContent = '—';
      stEl.textContent  = 'שגיאה';
      tEl.textContent   = '';
    }
  }
  loadOne();
  setInterval(loadOne, 5*60*1000);
})();
</script>

  <div class="wrap">
    <!-- כניסה בסיסית -->
    <div id="login-box" class="card">
      <div class="row" style="justify-content:space-between">
        <strong>כניסה</strong>
        <small class="muted">admin / 1234</small>
      </div>
      <form onsubmit="return false" class="row" style="margin-top:8px">
        <input id="login-user" placeholder="שם משתמש" style="flex:1 1 180px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <input id="login-pass" placeholder="סיסמה" type="password" style="flex:1 1 180px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <button id="login-btn">התחבר</button>
        <div id="login-msg" style="color:#991b1b"></div>
      </form>
    </div>

    <!-- בחירת לקוח -->
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <button id="pickCustomer">בחר לקוח</button>
        <div class="spacer"></div>
        <span class="muted">לקוח נוכחי</span>
      </div>
      <input id="currentCustomer" class="muted" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px" placeholder="לא נבחר" disabled />
      <div id="customerSummary" class="muted" style="margin-top:8px">—</div>
    </div>

    <!-- טבלת שוברים -->
    <div id="customerCoupons" class="card" style="display:none">
      <div class="row">
        <strong>שוברים</strong>
        <span id="couponMeta" class="pill">—</span>
        <div class="spacer"></div>
        <strong class="muted">פנוי למימוש:</strong>
        <span id="freeTotal" class="pill">₪ 0.00</span>
      </div>
      <div id="couponTable" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Modal בחירת לקוח -->
  <div id="custModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="hdr">
        <strong>בחר לקוח</strong>
        <button type="button" class="ghost small" id="custClose">סגור</button>
      </div>
      <input type="text" id="custSearch" placeholder="חפש לפי שם לקוח…" autocomplete="off" />
      <div class="cust-list" id="custList"></div>
    </div>
  </div>

  <script>
  // יציאה — ניקוי סטורג'
  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); sessionStorage.clear(); } catch(_) {}
    location.reload();
  };

  // לוגין לוקלי פשוט
  (function(){
    const LS='goodi_is_logged_in', box=document.getElementById('login-box');
    if(localStorage.getItem(LS)==='1'){ box.style.display='none'; document.documentElement.dataset.goodiAuthed='1'; }
    document.getElementById('login-btn').addEventListener('click',()=>{
      const u=document.getElementById('login-user').value.trim();
      const p=document.getElementById('login-pass').value.trim();
      if(u==='admin' && p==='1234'){ localStorage.setItem(LS,'1'); box.style.display='none'; document.documentElement.dataset.goodiAuthed='1'; document.dispatchEvent(new CustomEvent('goodi:authed')); }
      else{ const m=document.getElementById('login-msg'); m.textContent='שגיאת התחברות'; setTimeout(()=>m.textContent='',2000); }
    });
  })();

  (async function(){
    const ready = await window.supabaseReady;
    if(!ready || !ready.ok){ console.error('Supabase not ready'); return; }
    const sb = ready.client;

    // === בחירת לקוח – מודל עם חיפוש/אוטוקומפליט ===
    const modal = document.getElementById('custModal');
    const search = document.getElementById('custSearch');
    const list   = document.getElementById('custList');
    const btnPick= document.getElementById('pickCustomer');
    const btnClose= document.getElementById('custClose');

    let customersCache = [];

    function openModal(){ modal.style.display='flex'; search.value=''; renderCustomers(customersCache); setTimeout(()=>search.focus(),10); }
    function closeModal(){ modal.style.display='none'; }

    btnClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

    btnPick.addEventListener('click', async ()=>{
      if(document.documentElement.dataset.goodiAuthed!=='1'){ alert('יש להתחבר'); return; }
      if(customersCache.length===0){
        const { data, error } = await sb.from('customers').select('customer_id,name').order('name',{ascending:true}).limit(1000);
        if(error){ alert('שגיאה בטעינת לקוחות'); return; }
        customersCache = data || [];
      }
      openModal();
    });

    function renderCustomers(items){
      const needle = (search.value||'').trim().toLowerCase();
      const filtered = !needle ? items : items.filter(c => (c.name||'').toLowerCase().includes(needle));
      list.innerHTML = filtered.map(c=>`<div class="cust-item" data-id="${c.customer_id}">${c.name}</div>`).join('') || `<div class="cust-item tbl-note">אין תוצאות</div>`;
    }
    search.addEventListener('input', ()=>renderCustomers(customersCache));
    list.addEventListener('click', (e)=>{
      const el = e.target.closest('.cust-item'); if(!el || !el.dataset.id) return;
      const picked = customersCache.find(x=> String(x.customer_id) === el.dataset.id);
      if(!picked) return;
      closeModal();
      loadCustomer(picked);
    });

    // === טעינת לקוח ושוברים + פעולות ===
    async function loadCustomer(cust){
      document.getElementById('currentCustomer').value = cust.name || '(ללא שם)';
      document.getElementById('customerSummary').textContent = `מזהה: ${cust.customer_id ?? '-'}`;

      const $wrap=document.getElementById('customerCoupons');
      const $tbl =document.getElementById('couponTable');
      const $meta=document.getElementById('couponMeta');
      const $free=document.getElementById('freeTotal');

      $tbl.innerHTML = '<div class="muted">טוען…</div>';
      $wrap.style.display='block';

      const { data: coupons, error } = await sb
        .from('coupons')
        .select('id,date,amount,redeemed,redeemed_at')
        .eq('customer_id', cust.customer_id)
        .order('date',{ascending:false});

      if(error){ $tbl.innerHTML='<div class="muted">שגיאה בטעינת שוברים</div>'; $meta.textContent='שגיאה'; $free.textContent='₪ 0.00'; return; }
      if(!coupons?.length){ $tbl.innerHTML='<div class="muted">אין שוברים ללקוח</div>'; $meta.textContent='0'; $free.textContent='₪ 0.00'; return; }

      // סכום כולל פנוי למימוש
      const freeSum = coupons.filter(c=>!c.redeemed).reduce((s,c)=>s+Number(c.amount||0),0);
      $free.textContent = '₪ ' + freeSum.toFixed(2);

      $meta.textContent=String(coupons.length);
      const rows = coupons.map(c=>{
        const d = c.date ? new Date(c.date).toLocaleDateString('he-IL') : '—';
        const amt = `₪ ${Number(c.amount||0).toFixed(2)}`;
        const redeemed = !!c.redeemed;
        const redeemedMark = redeemed ? '✔︎' : '—';
        const actions = redeemed
          ? `<button class="small ghost" data-action="unredeem" data-id="${c.id}">בטל מימוש</button>`
          : `<button class="small" data-action="redeem" data-id="${c.id}">מימוש</button>`;
        const sub = c.redeemed_at ? `<div class="tbl-note">מומש: ${new Date(c.redeemed_at).toLocaleString('he-IL')}</div>` : '';
        return `<tr>
          <td>${d}${sub}</td>
          <td>${amt}</td>
          <td>${redeemedMark}</td>
          <td class="actions">${actions}</td>
        </tr>`;
      }).join('');

      $tbl.innerHTML = `
        <table>
          <thead><tr><th>תאריך</th><th>סכום</th><th>מומש</th><th>פעולות</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;

      // מאזינים לכפתורי פעולה
      $tbl.querySelectorAll('[data-action="redeem"]').forEach(btn=>{
        btn.addEventListener('click', ()=>handleRedeem(Number(btn.dataset.id), cust));
      });
      $tbl.querySelectorAll('[data-action="unredeem"]').forEach(btn=>{
        btn.addEventListener('click', ()=>handleUnredeem(Number(btn.dataset.id), cust));
      });
    }

    // מימוש – בלי אישור, קובע redeemed_at עכשיו
    async function handleRedeem(couponId, cust){
      const { error } = await sb.from('coupons').update({
        redeemed: true,
        redeemed_at: new Date().toISOString()
      }).eq('id', couponId).limit(1);
      if(error){ alert('שגיאה במימוש'); return; }
      loadCustomer(cust);
    }

    // ביטול מימוש – דורש שם מאשר
    async function handleUnredeem(couponId, cust){
      const approver = prompt('שם המאשר ביטול מימוש (חובה):');
      if(!approver || !approver.trim()){ alert('נדרש שם מאשר'); return; }
      const { error } = await sb.from('coupons').update({
        redeemed: false,
        redeemed_at: null
      }).eq('id', couponId).limit(1);
      if(error){ alert('שגיאה בביטול מימוש'); return; }
      // (אם תרצה לשמור את שם המאשר — נוסיף טבלת audit/עמודה ונכתוב לשם)
      loadCustomer(cust);
    }

  })();
  </script>
</body>
</html>
