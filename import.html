<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ייבוא שוברים (אחרי התחברות) — HTML/XLS → Supabase</title>

<!-- Supabase (עם fallback) -->
<script>
(function loadSupabase(){
  const urls=[
    "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js"
  ];
  (function go(i){
    if(i>=urls.length){document.dispatchEvent(new Event("supabase-ready"));return;}
    const s=document.createElement("script"); s.src=urls[i]; s.async=true;
    s.onload=()=>document.dispatchEvent(new Event("supabase-ready"));
    s.onerror=()=>go(i+1); document.head.appendChild(s);
  })(0);
})();
</script>

<!-- SheetJS לקריאת XLS/XLSX מקומי (שמור קובץ זה ליד ה-HTML) -->
<script src="xlsx.full.min.js"></script>

<style>
:root{
  --bg:#fff; --card:#fff; --line:#e5e7eb; --muted:#64748b; --ink:#0f172a; --blue:#0ea5e9; --red:#dc2626; --green:#16a34a;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Heebo,Arial}
header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:12px 16px}
.container{max-width:980px;margin:20px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
input,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff}
button{cursor:pointer}
button.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px}
.bad{color:var(--red)} .ok{color:var(--green)} .muted{color:var(--muted)}
.hidden{display:none}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--line);text-align:right}
thead th{position:sticky;top:64px;background:#fff}
</style>
</head>
<body>
<header><div class="container"><b>ייבוא שוברים</b> — HTML/XLS/XLSX → DB (תאריך, שם, תשלום)</div></header>

<div class="container">

  <!-- הגדרות פרויקט + התחברות -->
  <div class="card">
    <div class="row">
      <div class="col"><label>Supabase URL</label><input id="sbUrl" placeholder="https://xxxx.supabase.co"/></div>
      <div class="col"><label>Supabase anon key</label><input id="sbKey" placeholder="eyJ..."/></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><label>אימייל</label><input id="email" autocomplete="username"/></div>
      <div class="col"><label>סיסמה</label><input id="password" type="password" autocomplete="current-password"/></div>
      <div class="col" style="flex:0 0 180px;align-self:end">
        <button id="loginBtn" class="primary" style="width:100%">כניסה</button>
        <button id="logoutBtn" class="hidden" style="width:100%;margin-top:8px">יציאה</button>
      </div>
    </div>
    <div id="authMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- אזור עבודה – מוצג רק לאחר התחברות -->
  <div id="app" class="hidden">

    <!-- קובץ לקליטה -->
    <div class="card">
      <label>בחר קובץ (HTML / XLS / XLSX) עם טבלה: כותרות לדוגמה — תאריך | שם עובד | … | תשלום</label>
      <input id="fileInput" type="file"/>
      <div class="row" style="margin-top:10px">
        <div class="col" style="flex:0 0 180px"><button id="btnPreview">תצוגה מקדימה</button></div>
        <div class="col" style="flex:0 0 180px"><button id="btnImport" class="primary">ייבוא ל-DB</button></div>
      </div>
      <div id="importStatus" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- תצוגה מקדימה -->
    <div class="card"><div id="preview"></div></div>

    <!-- סיכומים מה-DB (רשות) -->
    <div class="card">
      <div class="row" style="align-items:end">
        <div class="col"><label>חפש לקוח</label><input id="balSearch" placeholder="הקלד שם לקוח…"/></div>
        <div class="col" style="flex:0 0 180px"><button id="btnRefresh" class="primary">רענן סיכומים</button></div>
      </div>
      <div id="balances" style="margin-top:10px"></div>
    </div>

  </div>
</div>

<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
const clean = t => (t||'').replace(/[\u200e\u200f]/g,'').replace(/\s+/g,' ').trim();
function parseAmount(s){
  if(!s) return 0;
  s = String(s).replace(/[₪,\s]/g,'').replace(/[^0-9.\-]/g,'');
  const n = parseFloat(s); return isNaN(n) ? 0 : n;
}
function normDateToISO(s){
  if(!s) return '';
  s=s.replace(/[\.]/g,'/').replace(/\s+/g,' ').trim();
  let m=s.match(/(\d{1,2})[\/](\d{1,2})[\/](\d{2,4})/); // dd/mm/yyyy
  if(m){let[d,mn,y]=[m[1],m[2],m[3]]; if(y.length===2) y='20'+y; return `${y.padStart(2,'0')}-${mn.padStart(2,'0')}-${d.padStart(2,'0')}`;}
  m=s.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);     // yyyy-mm-dd
  if(m){let[y,mn,d]=[m[1],m[2],m[3]]; return `${y.padStart(4,'0')}-${mn.padStart(2,'0')}-${d.padStart(2,'0')}`;}
  return s;
}
const isoToDDMMYYYY = iso => (!iso?'':(iso.split('-')[2]+'/'+iso.split('-')[1]+'/'+iso.split('-')[0]));
const fmtILS = n => new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0));

/* ===== Supabase ===== */
let supabase=null, currentUser=null, balancesCache=[];
document.addEventListener('supabase-ready', boot);

function saveConfig(){
  localStorage.setItem('sb_url', $('#sbUrl').value.trim());
  localStorage.setItem('sb_key', $('#sbKey').value.trim());
}
function loadConfig(){
  $('#sbUrl').value = localStorage.getItem('sb_url') || '';
  $('#sbKey').value = localStorage.getItem('sb_key') || '';
}
function setAuthUI(on,email){
  $('#authMsg').textContent = on ? `מחובר כ-${email||''}` : 'לא מחובר';
  $('#authMsg').className = on ? 'ok' : 'muted';
  $('#logoutBtn').classList.toggle('hidden', !on);
  $('#loginBtn').classList.toggle('hidden',  on);
  $('#app').classList.toggle('hidden', !on);
}

async function boot(){
  loadConfig();
  if(!window.supabase){ $('#authMsg').textContent='ספריית Supabase לא נטענה'; $('#authMsg').className='bad'; return; }

  const ensureClient = ()=>{
    const url=$('#sbUrl').value.trim(), key=$('#sbKey').value.trim();
    if(!url || !key){ $('#authMsg').textContent='הזן URL ו-anon key'; $('#authMsg').className='bad'; return null; }
    supabase = window.supabase.createClient(url, key, { auth:{persistSession:true, autoRefreshToken:true, detectSessionInUrl:true} });
    saveConfig();
    return supabase;
  };

  $('#loginBtn').onclick = async ()=>{
    try{
      if(!ensureClient()) return;
      $('#authMsg').textContent='מתחבר…'; $('#authMsg').className='muted';
      const email=$('#email').value.trim(), password=$('#password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      const { data:{ user } } = await supabase.auth.getUser();
      currentUser = user||null;
      setAuthUI(!!currentUser, currentUser?.email);
      if(currentUser) refreshBalances();
    }catch(e){
      $('#authMsg').textContent = 'שגיאה: '+(e.message||e); $('#authMsg').className='bad';
    }
  };

  $('#logoutBtn').onclick = async ()=>{
    try{ await supabase.auth.signOut(); }catch(_){}
    currentUser=null; setAuthUI(false);
  };

  // אם כבר מחובר (session קיים)
  if(ensureClient()){
    const { data:{ session } } = await supabase.auth.getSession();
    if(session?.user){ currentUser=session.user; setAuthUI(true, currentUser.email); refreshBalances(); }
    supabase.auth.onAuthStateChange((_e,sess)=>{
      if(sess?.user){ currentUser=sess.user; setAuthUI(true, currentUser.email); }
      else { currentUser=null; setAuthUI(false); }
    });
  }
}

/* ===== קריאת קובץ (HTML/XLS/XLSX) ===== */
let pickedRows=[]; // {date,name,amount}

function findBestHeaderIndex(headers, wanted, {exclude=[]}={}){
  const H=headers.map(h=>h.replace(/\s+/g,' ').trim().toLowerCase());
  const bad=i=>exclude.some(x=>H[i].includes(x));
  for(let i=0;i<H.length;i++){ if(!bad(i) && wanted.some(w=>H[i]===w)) return i; }
  for(let i=0;i<H.length;i++){ if(!bad(i) && wanted.some(w=>H[i].startsWith(w))) return i; }
  for(let i=0;i<H.length;i++){ if(!bad(i) && wanted.some(w=>H[i].includes(w))) return i; }
  return 0;
}

async function parseAsHTML(file){
  const html=await file.text();
  const doc=new DOMParser().parseFromString(html,'text/html');
  const tables=Array.from(doc.querySelectorAll('table')).sort((a,b)=>b.rows.length-a.rows.length);
  const t=tables[0]; if(!t) return null;
  const trs=Array.from(t.querySelectorAll('tr')); if(!trs.length) return null;
  const headCells = trs[0].querySelectorAll('th').length ? Array.from(trs[0].querySelectorAll('th')) : Array.from(trs[0].children);
  const headers=headCells.map(th=>clean(th.textContent).toLowerCase());
  trs.shift();
  const rows=trs.map(tr=>Array.from(tr.children).map(td=>clean(td.textContent)));

  const idx={
    date:  findBestHeaderIndex(headers,['תאריך','date']),
    name:  findBestHeaderIndex(headers,['שם עובד','שם לקוח','עובד','לקוח','customer','client','name']),
    amount:(function(){
      let i=findBestHeaderIndex(headers,['תשלום','payment','amount'],{exclude:['ללא','מע״מ','מעמ','vat','ללא מע״מ','before vat','without']});
      if(i===0 && !headers[0].includes('תשלום')) i=findBestHeaderIndex(headers,['סה"כ','סה״כ','total','grand total']);
      return i;
    })()
  };

  pickedRows = rows.map(r=>({
    date:  normDateToISO(r[idx.date]||''),
    name:  r[idx.name]||'',
    amount:parseAmount(r[idx.amount]||'0')
  })).filter(x=>x.name && x.date);

  return { headers, totalRows: rows.length };
}

async function parseAsExcel(file){
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type:'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:'' });
  if(!arr.length) return null;
  const headers = (arr[0]||[]).map(x=>clean(String(x)).toLowerCase());
  const rows = arr.slice(1).map(r => r.map(x=>clean(String(x))));

  const idx={
    date:  findBestHeaderIndex(headers,['תאריך','date']),
    name:  findBestHeaderIndex(headers,['שם עובד','שם לקוח','עובד','לקוח','customer','client','name']),
    amount:(function(){
      let i=findBestHeaderIndex(headers,['תשלום','payment','amount'],{exclude:['ללא','מע״מ','מעמ','vat','ללא מע״מ','before vat','without']});
      if(i===0 && !headers[0].includes('תשלום')) i=findBestHeaderIndex(headers,['סה"כ','סה״כ','total','grand total']);
      return i;
    })()
  };

  pickedRows = rows.map(r=>({
    date:  normDateToISO(r[idx.date]||''),
    name:  r[idx.name]||'',
    amount:parseAmount(r[idx.amount]||'0')
  })).filter(x=>x.name && x.date);

  return { headers, totalRows: rows.length };
}

async function readFile(){
  const f=$('#fileInput').files?.[0]; if(!f) return null;
  const ext=(f.name.split('.').pop()||'').toLowerCase();
  if(['xls','xlsx'].includes(ext)) return await parseAsExcel(f);
  // ברירת מחדל: HTML
  return await parseAsHTML(f);
}

/* ===== תצוגה מקדימה ===== */
$('#btnPreview').onclick = async ()=>{
  if(!currentUser){ $('#importStatus').textContent='יש להתחבר קודם'; $('#importStatus').className='bad'; return; }
  const info = await readFile();
  if(!info){ $('#importStatus').textContent='קובץ/טבלה לא תקינים'; $('#importStatus').className='bad'; return; }

  // איחוד כפילויות (שם+תאריך)
  const map=new Map();
  for(const r of pickedRows){
    const k=`${r.name}|${r.date}`;
    if(!map.has(k)) map.set(k,{...r}); else map.get(k).amount+=Number(r.amount||0);
  }
  const sample=[...map.values()].slice(0,20);

  let html=`<div class="muted"><b>תצוגה מקדימה</b> — שורות מוצגות: ${sample.length} מתוך ${map.size} (אחרי איחוד כפילויות)</div>`;
  html+='<div style="max-height:340px;overflow:auto"><table><thead><tr><th>תאריך</th><th>שם עובד</th><th>תשלום</th></tr></thead><tbody>';
  sample.forEach(r=> html+=`<tr><td>${isoToDDMMYYYY(r.date)}</td><td>${r.name}</td><td>${fmtILS(r.amount)}</td></tr>`);
  html+='</tbody></table></div>';
  $('#preview').innerHTML=html;
  $('#importStatus').textContent='';
};

/* ===== ייבוא ל-DB ===== */
$('#btnImport').onclick = async ()=>{
  try{
    if(!currentUser){ $('#importStatus').textContent='יש להתחבר קודם'; $('#importStatus').className='bad'; return; }
    const info = await readFile();
    if(!info){ $('#importStatus').textContent='קובץ/טבלה לא תקינים'; $('#importStatus').className='bad'; return; }
    $('#importStatus').textContent='מייבא…'; $('#importStatus').className='muted';

    // איחוד כפילויות (שם+תאריך)
    const uniq=new Map();
    for(const r of pickedRows){
      const k=`${r.name}|${r.date}`;
      if(!uniq.has(k)) uniq.set(k,{...r}); else uniq.get(k).amount+=Number(r.amount||0);
    }
    const rowsForImport=[...uniq.values()];
    if(!rowsForImport.length){ $('#importStatus').textContent='אין רשומות חוקיות לייבוא'; $('#importStatus').className='bad'; return; }

    // upsert לקוחות לפי name (ללא עדכון שורות קיימות)
    const uniqueNames = [...new Set(rowsForImport.map(x=>x.name))];
    const { error:cErr } = await supabase.from('customers').upsert(
      uniqueNames.map(n=>({ name:n })),
      { onConflict:'name', ignoreDuplicates:true }
    );
    if(cErr) throw cErr;

    // שליפת ids
    const { data:cust, error:gErr } = await supabase.from('customers')
      .select('customer_id,name').in('name', uniqueNames);
    if(gErr) throw gErr;
    const idByName = Object.fromEntries((cust||[]).map(c=>[c.name, c.customer_id]));

    // בניית שוברים
    const coupons = rowsForImport
      .map(x=>({ customer_id:idByName[x.name], date:x.date, amount:x.amount, redeemed:false, source_label:'upload' }))
      .filter(x=>x.customer_id);

    // upsert חלקי (על customer_id+date), ללא עדכון קיימות
    const CHUNK=500;
    for(let i=0;i<coupons.length;i+=CHUNK){
      const slice=coupons.slice(i,i+CHUNK);
      const { error:uErr } = await supabase.from('coupons').upsert(
        slice,
        { onConflict:'customer_id,date', ignoreDuplicates:true }
      );
      if(uErr) throw uErr;
    }

    $('#importStatus').textContent=`הייבוא הושלם. נרשמו/דלגו ${coupons.length} רשומות.`; $('#importStatus').className='ok';
    refreshBalances();
  }catch(e){
    $('#importStatus').textContent='שגיאה: '+(e.message||e); $('#importStatus').className='bad';
  }
};

/* ===== סיכומי לקוחות ===== */
async function refreshBalances(){
  try{
    const { data, error } = await supabase.from('customer_balances').select('*').order('name');
    if(error) throw error;
    balancesCache=data||[];
    renderBalances(balancesCache);
  }catch(e){
    $('#balances').innerHTML='<span class="bad">שגיאה: '+(e.message||e)+'</span>';
  }
}
function renderBalances(list){
  let html='<table><thead><tr><th>לקוח</th><th>סה״כ נטען</th><th>סה״כ מומש</th><th>זמין</th></tr></thead><tbody>';
  list.forEach(r=>{
    html+=`<tr><td>${r.name}</td><td>${fmtILS(r.total_loaded)}</td><td>${fmtILS(r.total_redeemed)}</td><td><b>${fmtILS(r.available_amount)}</b></td></tr>`;
  });
  html+='</tbody></table>';
  $('#balances').innerHTML=html;
}
$('#btnRefresh').addEventListener('click', refreshBalances);
$('#balSearch').addEventListener('input', ()=>{
  const q=$('#balSearch').value.toLowerCase().trim();
  const filtered = balancesCache.filter(r=> (r.name||'').toLowerCase().includes(q));
  renderBalances(filtered);
});
</script>
</body>
</html>
