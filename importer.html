<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ייבוא שוברים מ־HTML → Supabase</title>

<!-- supabase-js עם Fallback -->
<script>
(function loadSupabase(){
  const urls=[
    "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js"
  ];
  (function go(i){
    if(i>=urls.length){document.dispatchEvent(new Event("supabase-ready"));return;}
    const s=document.createElement("script"); s.src=urls[i]; s.async=true;
    s.onload=()=>document.dispatchEvent(new Event("supabase-ready"));
    s.onerror=()=>go(i+1); document.head.appendChild(s);
  })(0);
})();
</script>

<!-- SheetJS (XLSX) עם Fallback -->
<script>
(function loadXLSX(){
  const urls = [
    "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"
  ];
  (function go(i){
    if (i >= urls.length) { document.dispatchEvent(new Event("xlsx-ready")); return; }
    const s = document.createElement("script");
    s.src = urls[i]; s.async = true;
    s.onload = () => document.dispatchEvent(new Event("xlsx-ready"));
    s.onerror = () => go(i+1);
    document.head.appendChild(s);
  })(0);
})();
</script>

<style>
:root{
  --bg:#ffffff; --card:#ffffff; --muted:#5b6b7a; --text:#0f172a;
  --line:#e5e7eb; --green:#16a34a; --red:#dc2626; --blue:#0ea5e9;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Heebo,Arial}
header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);
  padding:12px 16px;border-bottom:1px solid var(--line)}
.container{max-width:980px;margin:20px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
input,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text)}
button{cursor:pointer}
button.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
.hint{color:var(--muted);font-size:13px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 260px}
.ok{color:var(--green)} .bad{color:var(--red)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--line);text-align:right}
thead th{position:sticky;top:64px;background:#fff}
</style>
</head>
<body>
<header><div class="container"><b>ייבוא שוברים</b> — HTML → DB (תאריך, שם עובד, תשלום)</div></header>
<div class="container">

  <!-- חיבור -->
  <div class="card">
    <div class="row">
      <div class="col"><label>Supabase URL</label><input id="sbUrl"/></div>
      <div class="col"><label>Supabase anon key</label><input id="sbKey"/></div>
    </div>
    <div id="connStatus" class="hint">מחבר…</div>
  </div>

  <!-- קובץ HTML/CSV/XLS -->
  <div class="card">
    <label>קובץ HTML עם טבלה (כותרות לדוגמה: תאריך | שם עובד | … | תשלום | …)</label>
    <input id="fileInput" type="file"/>
    <div style="margin-top:10px;display:flex;gap:10px">
      <button id="btnPreview">תצוגה מקדימה</button>
      <button id="btnImport" class="primary">ייבוא ל־DB</button>
    </div>
    <div id="importStatus" class="hint" style="margin-top:8px"></div>
  </div>

  <!-- תצוגה מקדימה -->
  <div class="card"><div id="preview"></div></div>

  <!-- לקוחות וסיכומים -->
  <div class="card">
    <div class="row" style="align-items:end">
      <div class="col"><label>חפש לקוח</label><input id="balSearch" placeholder="הקלד שם לקוח…"/></div>
      <div class="col" style="flex:0 0 200px"><button id="btnRefresh" class="primary">רענן סיכומים</button></div>
    </div>
    <div id="balances" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
function clean(t){ return (t||'').replace(/[\u200e\u200f]/g,'').replace(/\s+/g,' ').trim(); }
function parseAmount(s){
  if(!s) return 0;
  s = String(s).replace(/[₪,\s]/g,'').replace(/[^0-9.\-]/g,'');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function normDateToISO(s){
  if(!s) return '';
  s=s.replace(/[\.]/g,'/').replace(/\s+/g,' ').trim();
  let m=s.match(/(\d{1,2})[\/](\d{1,2})[\/](\d{2,4})/); // dd/mm/yyyy
  if(m){let[d,mn,y]=[m[1],m[2],m[3]]; if(y.length===2) y='20'+y; return `${y.padStart(4,'0')}-${mn.padStart(2,'0')}-${d.padStart(2,'0')}`;}
  m=s.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);     // yyyy-mm-dd
  if(m){let[y,mn,d]=[m[1],m[2],m[3]]; return `${y.padStart(4,'0')}-${mn.padStart(2,'0')}-${d.padStart(2,'0')}`;}
  return s;
}
function isoToDDMMYYYY(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-'); if(!y||!m||!d) return iso; return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`; }
function fmtILS(n){ return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0)); }

/* ===== Supabase ===== */
const DEFAULT_URL = "https://ylqpxwgchwalcblfipsu.supabase.co";
const DEFAULT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";
let supabase=null, balancesCache=[];

async function initSupabase(){
  $('#sbUrl').value = localStorage.getItem('sb_url') || DEFAULT_URL;
  $('#sbKey').value = localStorage.getItem('sb_key') || DEFAULT_KEY;
  if(!window.supabase){ $('#connStatus').textContent='ספריית Supabase לא נטענה'; return; }
  supabase = window.supabase.createClient($('#sbUrl').value.trim(), $('#sbKey').value.trim());
  localStorage.setItem('sb_url', $('#sbUrl').value.trim());
  localStorage.setItem('sb_key', $('#sbKey').value.trim());
  const { error } = await supabase.auth.getSession();
  $('#connStatus').textContent = error ? ('שגיאה: '+error.message) : 'מחובר ל-Supabase';
  refreshBalances();
}
document.addEventListener('supabase-ready', initSupabase);
['change','blur'].forEach(evt=>{
  $('#sbUrl').addEventListener(evt, initSupabase);
  $('#sbKey').addEventListener(evt, initSupabase);
});

/* ===== המתנה בטוחה לטעינת XLSX ===== */
const xlsxLoaded = new Promise((resolve) => {
  if (typeof window.XLSX !== 'undefined') return resolve();
  document.addEventListener('xlsx-ready', () => resolve(), { once: true });
});
async function ensureXLSXReady(){
  if (typeof window.XLSX !== 'undefined') return;
  await xlsxLoaded;
  if (typeof window.XLSX === 'undefined') {
    throw new Error('ספריית XLSX לא נטענה (נחסמה ע״י רשת/חוסם?)');
  }
}

/* ===== קובץ + מיפוי אוטומטי ===== */
let pickedRows=[];

function isProbablyHTML(txt){
  const s=(txt||'').trim().slice(0,400).toLowerCase();
  return /<(html|table|thead|tbody|tr|td|th)\b/.test(s) || s.startsWith('<!doctype');
}
function parseCSV(text){
  const rows=[]; let row=[], cur='', inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch === '"'){ if(inQ && next === '"'){ cur+='"'; i++; } else inQ = !inQ; }
    else if(ch === ',' && !inQ){ row.push(cur); cur=''; }
    else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && next === '\n'){ i++; }
      row.push(cur); rows.push(row); row=[]; cur='';
    } else { cur += ch; }
  }
  row.push(cur); rows.push(row);
  return rows.map(r=> r.map(c=> String(c??'').trim()));
}
function csvToHtmlTable(text){
  const rows = parseCSV(text).filter(r=> r.some(c=> (c||'').trim() !== ''));
  if(!rows.length) return '<table></table>';
  const head = rows[0];
  const body = rows.slice(1);
  const esc = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  let html = '<table><thead><tr>';
  head.forEach(h=> html += `<th>${esc(h)}</th>`);
  html += '</tr></thead><tbody>';
  body.forEach(r=>{
    html += '<tr>' + r.map(c=> `<td>${esc(c)}</td>`).join('') + '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

/* המרה אחידה: קובץ → HTML (תומך XLS/XLSX/CSV/HTML) */
async function fileToHtml(f) {
  const name = (f?.name || '').toLowerCase();
  if (name.endsWith('.xls') || name.endsWith('.xlsx')) {
    await ensureXLSXReady();
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_html(ws, { header: '', footer: '' });
  } else {
    const raw = await f.text();
    return isProbablyHTML(raw) ? raw : csvToHtmlTable(raw);
  }
}

function findBestHeaderIndex(headers, wanted, {exclude=[]}={}){
  const H = headers.map(h => h.replace(/\s+/g,' ').trim().toLowerCase());
  const isBad = i => exclude.some(x => H[i].includes(x));
  for(let i=0;i<H.length;i++){ if(isBad(i)) continue; if(wanted.some(w=>H[i]===w)) return i; }
  for(let i=0;i<H.length;i++){ if(isBad(i)) continue; if(wanted.some(w=>H[i].startsWith(w))) return i; }
  for(let i=0;i<H.length;i++){ if(isBad(i)) continue; if(wanted.some(w=>H[i].includes(w))) return i; }
  return 0;
}

async function readFile(){
  const f = $('#fileInput').files?.[0]; if(!f) return null;
  const html = await fileToHtml(f);
  const doc  = new DOMParser().parseFromString(html,'text/html');

  const tables = Array.from(doc.querySelectorAll('table')).sort((a,b)=>b.rows.length-a.rows.length);
  const t = tables[0]; if(!t) return null;

  const trs = Array.from(t.querySelectorAll('tr')); if(!trs.length) return null;
  const headCells = trs[0].querySelectorAll('th').length ? Array.from(trs[0].querySelectorAll('th')) : Array.from(trs[0].children);
  const headers = headCells.map(th=> clean(th.textContent).toLowerCase());
  trs.shift();
  const rows = trs.map(tr=> Array.from(tr.children).map(td=> clean(td.textContent)));

  const idx = {
    date:  findBestHeaderIndex(headers, ['תאריך','date']),
    name:  findBestHeaderIndex(headers, ['שם עובד','שם לקוח','עובד','לקוח','customer','client','name']),
    amount: (function(){
      let i = findBestHeaderIndex(
        headers,
        ['תשלום','payment','amount'],
        { exclude:['ללא','מע״מ','מעמ','vat','ללא מע״מ','before vat','without'] }
      );
      if(i===0 && !headers[0].includes('תשלום')) {
        i = findBestHeaderIndex(headers, ['סה"כ','סה״כ','total','grand total']);
      }
      return i;
    })()
  };

  pickedRows = rows.map(r=>({
    date:  normDateToISO(r[idx.date]  || ''),
    name:  r[idx.name]           || '',
    amount:parseAmount(r[idx.amount]|| '0')
  })).filter(x=> x.name && x.date);

  return { headers, idx, totalRows: rows.length };
}

/* ===== תצוגה מקדימה ===== */
$('#btnPreview').onclick = async ()=>{
  const info = await readFile();
  if(!info){ $('#importStatus').textContent='לא נמצאה טבלה בקובץ / כותרות לא מזוהות'; return; }

  const map = new Map();
  for(const r of pickedRows){
    const key = `${r.name}|${r.date}`;
    if(!map.has(key)) map.set(key, {...r});
    else map.get(key).amount += Number(r.amount||0);
  }
  const sample = Array.from(map.values()).slice(0,20);

  let html = `<div class="hint"><b>תצוגה מקדימה</b> — שורות מוצגות: ${sample.length} מתוך ${map.size} (לאחר איחוד כפילויות)</div>`;
  html += '<div style="max-height:340px;overflow:auto"><table><thead><tr><th>תאריך</th><th>שם עובד</th><th>תשלום</th></tr></thead><tbody>';
  sample.forEach(r=> html += `<tr><td>${isoToDDMMYYYY(r.date)}</td><td>${r.name}</td><td>${fmtILS(r.amount)}</td></tr>`);
  html += '</tbody></table></div>';
  $('#preview').innerHTML = html;
};

/* ===== ייבוא ל־DB ===== */
$('#btnImport').onclick = async ()=>{
  try{
    if(!supabase) await initSupabase();
    $('#importStatus').textContent='מייבא…';
    const info = await readFile();
    if(!info){ $('#importStatus').innerHTML='<span class="bad">קובץ/טבלה לא תקינים</span>'; return; }

    const uniqueMap = new Map();
    for (const row of pickedRows) {
      const key = `${row.name}|${row.date}`;
      if (!uniqueMap.has(key)) uniqueMap.set(key, { ...row });
      else uniqueMap.get(key).amount += Number(row.amount || 0);
    }
    const rowsForImport = Array.from(uniqueMap.values());
    if(!rowsForImport.length){ $('#importStatus').innerHTML='<span class="bad">אין רשומות חוקיות לייבוא</span>'; return; }

    const uniqueNames = Array.from(new Set(rowsForImport.map(x=>x.name)));
    const { error: cErr } = await supabase.from('customers').upsert(
      uniqueNames.map(n=>({name:n})),
      { onConflict:'name' }
    );
    if(cErr){ $('#importStatus').innerHTML = '<span class="bad">שגיאה ביצירת לקוחות: '+cErr.message+'</span>'; return; }

    const { data: cust, error: gErr } = await supabase.from('customers')
      .select('customer_id,name').in('name', uniqueNames);
    if(gErr){ $('#importStatus').innerHTML = '<span class="bad">שגיאה בקריאת לקוחות: '+gErr.message+'</span>'; return; }
    const idByName = Object.fromEntries((cust||[]).map(c=>[c.name, c.customer_id]));

    const coupons = rowsForImport
      .map(x=>({ customer_id: idByName[x.name], date: x.date, amount: x.amount, redeemed:false, source_label:'html-upload' }))
      .filter(x=>x.customer_id);

    const CHUNK=500;
    for(let i=0;i<coupons.length;i+=CHUNK){
      const slice=coupons.slice(i,i+CHUNK);
      const { error: uErr } = await supabase.from('coupons').upsert(
        slice,
        { onConflict:'customer_id,date', ignoreDuplicates:true }
      );
      if(uErr){ $('#importStatus').innerHTML = '<span class="bad">שגיאת ייבוא: '+uErr.message+'</span>'; return; }
    }

    $('#importStatus').innerHTML = `<span class="ok">הייבוא הושלם. הוכנסו/דלגו ${coupons.length} רשומות (ללא עדכון קיימות).</span>`;
    refreshBalances();
  }catch(e){
    $('#importStatus').innerHTML = '<span class="bad">שגיאה: '+(e.message||e)+'</span>';
  }
};

/* ===== סיכומי לקוחות ===== */
async function refreshBalances(){
  try{
    const { data, error } = await supabase.from('customer_balances').select('*').order('name');
    if(error){ $('#balances').innerHTML='<span class="hint">שגיאה: '+(error.message||'')+'</span>'; return; }
    balancesCache = data||[];
    renderBalances(balancesCache);
  }catch(e){ $('#balances').innerHTML='<span class="hint">שגיאה: '+(e.message||e)+'</span>'; }
}
function renderBalances(list){
  let html='<table><thead><tr><th>לקוח</th><th>סה״כ נטען</th><th>סה״כ מומש</th><th>זמין</th></tr></thead><tbody>';
  list.forEach(r=>{
    html+=`<tr><td>${r.name}</td><td>${fmtILS(r.total_loaded)}</td><td>${fmtILS(r.total_redeemed)}</td><td><b>${fmtILS(r.available_amount)}</b></td></tr>`;
  });
  html+='</tbody></table>';
  $('#balances').innerHTML=html;
}
$('#btnRefresh').addEventListener('click', refreshBalances);
$('#balSearch').addEventListener('input', ()=>{
  const q=$('#balSearch').value.toLowerCase().trim();
  const filtered = balancesCache.filter(r=> r.name.toLowerCase().includes(q));
  renderBalances(filtered);
});
</script>
</body>
</html>
