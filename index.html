<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ניהול שוברים • טעינת HTML → Supabase</title>
  <!-- ספריית Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root{--bg:#0b111b;--card:#101826;--muted:#9fb3c8;--text:#e6edf6;--accent:#46a758;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Heebo,Arial,sans-serif;background:#0b111b;color:var(--text)}
    header{position:sticky;top:0;background:#0b111bcc;backdrop-filter:blur(10px);padding:14px 16px;border-bottom:1px solid #1f2a3a}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2a3a;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3a52;background:#0b111b;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a7f4b,#11623a);border-color:#125b35}
    button.secondary{background:#0b111b}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #263246;text-align:right}
    th{background:#0e1523;position:sticky;top:68px}
    .ok{color:#22c55e}.bad{color:#ef4444}
    .status{font-size:12px;color:#9fb3c8}
  </style>
</head>
<body>
<header>
  <div class="container"><b>ניהול שוברים</b> — טעינת דוח HTML → DB, צפייה לפי לקוח וסימון מומש</div>
</header>
<div class="container">

  <!-- חיבור ל-Supabase -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>Supabase URL</label>
        <input id="supabaseUrl" />
      </div>
      <div class="col">
        <label>Supabase anon key</label>
        <input id="supabaseKey" />
      </div>
    </div>
    <div class="status" id="connStatus">מתחבר…</div>
    <div class="hint">החיבור נוצר אוטומטית בעת טעינת הדף ובכל שינוי בשדות.</div>
  </div>

  <!-- התחברות -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>אימייל</label>
        <input id="email" type="email" />
      </div>
      <div class="col">
        <label>סיסמה</label>
        <input id="password" type="password" />
      </div>
      <div class="col" style="flex:0 0 220px;align-self:end">
        <button id="btnSignIn" class="secondary">התחבר / הירשם</button>
      </div>
    </div>
    <div id="authStatus" class="hint"></div>
  </div>

  <!-- ייבוא דוח HTML -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>קובץ HTML (עם טבלה: תאריך, שם לקוח, סכום שובר)</label>
        <input id="fileInput" type="file" accept=".html,.htm,text/html" />
      </div>
      <div class="col">
        <label>בחירת טבלה במסמך</label>
        <select id="tableSelect"></select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label>תאריך</label><select id="dateSelect"></select></div>
      <div class="col"><label>שם לקוח</label><select id="nameSelect"></select></div>
      <div class="col"><label>סכום שובר</label><select id="amountSelect"></select></div>
    </div>
    <div class="row">
      <div class="col" style="flex:0 0 220px;align-self:end">
        <button id="btnPreview" class="secondary">תצוגה מקדימה</button>
      </div>
      <div class="col" style="flex:0 0 260px;align-self:end">
        <button id="btnImport" class="primary">ייבוא ל־DB</button>
      </div>
    </div>
    <div id="importStatus" class="hint"></div>
  </div>

  <!-- סיכומי לקוחות -->
  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div><b>לקוחות וסיכומים</b></div>
      <div class="row" style="gap:8px;flex:0 0 auto">
        <button id="btnRefresh" class="secondary">רענן</button>
      </div>
    </div>
    <div id="customersWrap" style="margin-top:10px"></div>
  </div>

  <!-- פרטי לקוח -->
  <div class="card" id="customerCard" style="display:none">
    <div class="row">
      <div class="col"><b id="custTitle">פרטי לקוח</b></div>
      <div class="col" style="flex:0 0 220px;align-self:end">
        <button id="btnBack" class="secondary">חזרה לרשימה</button>
      </div>
    </div>
    <div id="couponsWrap" style="margin-top:10px"></div>
  </div>

</div>

<script>
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const DEFAULT_SUPABASE_URL = "https://ylqpxwgchwalcblfipsu.supabase.co";
  const DEFAULT_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";

  let supabase = null, currentUser = null;
  const supabaseUrlEl = $('#supabaseUrl'), supabaseKeyEl = $('#supabaseKey');
  const connStatus = $('#connStatus'), authStatus = $('#authStatus');

  async function initSupabaseClient(){
    try {
      connStatus.textContent = 'מתחבר…';
      const url = (supabaseUrlEl.value || '').trim() || DEFAULT_SUPABASE_URL;
      const key = (supabaseKeyEl.value || '').trim() || DEFAULT_ANON_KEY;

      supabase = window.Supabase.createClient(url, key);
      localStorage.setItem('sb_url', url);
      localStorage.setItem('sb_key', key);

      // בדיקת חיבור אמיתית
      const { error } = await supabase.auth.getSession();
      if (error) {
        connStatus.textContent = 'שגיאת חיבור: ' + error.message;
        console.error(error);
        return;
      }
      connStatus.textContent = 'מחובר ל-Supabase';
    } catch (e) {
      connStatus.textContent = 'שגיאה כללית';
      console.error(e);
    }
  }

  function loadAndConnect(){
    supabaseUrlEl.value = localStorage.getItem('sb_url') || DEFAULT_SUPABASE_URL;
    supabaseKeyEl.value = localStorage.getItem('sb_key') || DEFAULT_ANON_KEY;
    initSupabaseClient();
  }

  // התחברות אימייל/סיסמה
  $('#btnSignIn').addEventListener('click', async ()=>{
    if(!supabase){ await initSupabaseClient(); }
    const email = ($('#email').value || '').trim();
    const password = ($('#password').value || '').trim();
    if(!email || !password){ alert('נא למלא אימייל וסיסמה'); return; }
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){
      const { error: signUpErr } = await supabase.auth.signUp({ email, password });
      if(signUpErr){ authStatus.textContent = 'שגיאת התחברות: ' + signUpErr.message; return; }
      authStatus.textContent = 'נרשמת. אמת/י והתחבר/י שוב.';
    } else {
      currentUser = data.user;
      authStatus.textContent = 'מחובר כ-' + (currentUser?.email||'');
      refreshCustomers();
    }
  });

  // התחברות אוטומטית בכל שינוי ב-URL/Key
  ['change','blur','input'].forEach(evt=>{
    supabaseUrlEl.addEventListener(evt, ()=>{ initSupabaseClient(); });
    supabaseKeyEl.addEventListener(evt, ()=>{ initSupabaseClient(); });
  });

  document.addEventListener('DOMContentLoaded', loadAndConnect);

  /* כאן ממשיכים הפונקציות של טעינת HTML, import, הצגת לקוחות וכו’... */
</script>
</body>
</html>
