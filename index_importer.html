<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ניהול שוברים • טעינת HTML → Supabase</title>

  <!-- טעינת supabase-js עם Fallbackים -->
  <script>
    (function loadSupabase() {
      const urls = [
        "https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
        "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js"
      ];
      function tryNext(i){
        if(i>=urls.length){ console.error("Failed to load supabase-js from all CDNs"); document.dispatchEvent(new Event("supabase-ready")); return; }
        const s=document.createElement("script");
        s.src=urls[i]; s.async=true; s.crossOrigin="anonymous";
        s.onload=()=>{ document.dispatchEvent(new Event("supabase-ready")); };
        s.onerror=()=>{ console.warn("CDN failed:", urls[i]); tryNext(i+1); };
        document.head.appendChild(s);
      }
      tryNext(0);
    })();
  </script>

  <style>
    :root{--bg:#0b111b;--card:#101826;--muted:#9fb3c8;--text:#e6edf6;--green:#22c55e;--red:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Heebo,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#0b111bcc;backdrop-filter:blur(10px);padding:14px 16px;border-bottom:1px solid #1f2a3a}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#101826;border:1px solid #1f2a3a;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3a52;background:#0b111b;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a7f4b,#11623a)}
    button.secondary{background:#0b111b}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:8px 10px;border-bottom:1px solid #263246;text-align:right}
    th{background:#0e1523;position:sticky;top:68px}
    .ok{color:var(--green)} .bad{color:var(--red)}
    .status{font-size:12px;color:#9fb3c8}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a52;font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="container"><b>ניהול שוברים</b> — טעינת דוח HTML → DB, צפייה לפי לקוח וסימון מומש</div>
</header>
<div class="container">

  <!-- חיבור ל-Supabase -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>Supabase URL</label>
        <input id="supabaseUrl" />
      </div>
      <div class="col">
        <label>Supabase anon key</label>
        <input id="supabaseKey" />
      </div>
    </div>
    <div class="status" id="connStatus">טוען ספריית Supabase…</div>
    <div class="hint">החיבור נוצר אוטומטית בעת טעינת הדף ובכל שינוי בשדות.</div>
  </div>

  <!-- התחברות -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>אימייל</label>
        <input id="email" type="email" />
      </div>
      <div class="col">
        <label>סיסמה</label>
        <input id="password" type="password" />
      </div>
      <div class="col" style="flex:0 0 220px;align-self:end">
        <button id="btnSignIn" class="secondary">התחבר / הירשם</button>
      </div>
    </div>
    <div id="authStatus" class="hint"></div>
  </div>

  <!-- ייבוא דוח HTML -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>קובץ HTML (עם טבלה: תאריך, שם לקוח, סכום שובר)</label>
        <input id="fileInput" type="file" accept=".html,.htm,text/html" />
      </div>
      <div class="col">
        <label>בחירת טבלה במסמך</label>
        <select id="tableSelect"></select>
      </div>
    </div>
    <div class="row">
      <div class="col"><label>תאריך</label><select id="dateSelect"></select></div>
      <div class="col"><label>שם לקוח</label><select id="nameSelect"></select></div>
      <div class="col"><label>סכום שובר</label><select id="amountSelect"></select></div>
    </div>
    <div class="row">
      <div class="col" style="flex:0 0 220px;align-self:end">
        <button id="btnPreview" class="secondary">תצוגה מקדימה</button>
      </div>
      <div class="col" style="flex:0 0 260px;align-self:end">
        <button id="btnImport" class="primary">ייבוא ל־DB</button>
      </div>
    </div>
    <div id="importStatus" class="hint"></div>
  </div>

  <!-- סיכומי לקוחות -->
  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div><b>לקוחות וסיכומים</b></div>
      <div class="row" style="gap:8px;flex:0 0 auto">
        <button id="btnRefresh" class="secondary">רענן</button>
      </div>
    </div>
    <div id="customersWrap" style="margin-top:10px"></div>
  </div>

  <!-- פרטי לקוח -->
  <div class="card" id="customerCard" style="display:none">
    <div class="row">
      <div class="col"><b id="custTitle">פרטי לקוח</b></div>
      <div class="col" style="flex:0 0 220px;align-self:end">
        <button id="btnBack" class="secondary">חזרה לרשימה</button>
      </div>
    </div>
    <div id="couponsWrap" style="margin-top:10px"></div>
  </div>

</div>

<script>
  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function cleanText(t){return (t||'').replace(/[\u200e\u200f]/g,'').replace(/\s+/g,' ').trim();}
  function parseAmount(s){ if(!s) return 0; s=String(s).replace(/[₪,\s]/g,'').replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return isNaN(n)?0:n; }
  function normalizeDate(s){
    if(!s) return '';
    s=s.replace(/[\.]/g,'/').replace(/\s+/g,' ').trim();
    const m1=s.match(/(\d{1,2})[\/](\d{1,2})[\/](\d{2,4})/);
    if(m1){ let [_,d,m,y]=m1; if(y.length===2) y='20'+y; return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;}
    const m2=s.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
    if(m2){ let [_,y,m,d]=m2; return `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;}
    return s;
  }
  function fmtILS(n){ return new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n||0)); }
  function safeMsg(err){ const t=(err&&(err.message||err.statusText||err.name))||String(err||'Unknown'); console.error(err); return t; }

  // ===== Supabase client =====
  const DEFAULT_SUPABASE_URL = "https://ylqpxwgchwalcblfipsu.supabase.co";
  const DEFAULT_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscXB4d2djaHdhbGNibGZpcHN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTk3MzQsImV4cCI6MjA3MTM5NTczNH0.bHNNmDlvUj-K1KFYZ1eNSKdzB_EpLmf2KiRhYTrWVPM";

  let supabase = null, currentUser = null;
  const supabaseUrlEl = $('#supabaseUrl'), supabaseKeyEl = $('#supabaseKey');
  const connStatus = $('#connStatus'), authStatus = $('#authStatus');

  async function initSupabaseClient(){
    try {
      connStatus.textContent = 'מתחבר…';
      if(!window.supabase){ connStatus.textContent = 'ספריית Supabase לא נטענה'; return; }
      const url = (supabaseUrlEl.value||'').trim() || DEFAULT_SUPABASE_URL;
      const key = (supabaseKeyEl.value||'').trim() || DEFAULT_ANON_KEY;

      supabase = window.supabase.createClient(url, key);
      localStorage.setItem('sb_url', url);
      localStorage.setItem('sb_key', key);

      const { error } = await supabase.auth.getSession();
      if(error){ connStatus.textContent = 'שגיאת חיבור: ' + safeMsg(error); return; }
      connStatus.textContent = 'מחובר ל-Supabase';
    } catch(e){ connStatus.textContent = 'שגיאה כללית: ' + safeMsg(e); }
  }

  function loadAndConnect(){
    supabaseUrlEl.value = localStorage.getItem('sb_url') || DEFAULT_SUPABASE_URL;
    supabaseKeyEl.value = localStorage.getItem('sb_key') || DEFAULT_ANON_KEY;
    initSupabaseClient();
  }
  ['change','blur','input'].forEach(evt=>{
    supabaseUrlEl.addEventListener(evt, initSupabaseClient);
    supabaseKeyEl.addEventListener(evt, initSupabaseClient);
  });
  document.addEventListener('supabase-ready', loadAndConnect);

  // ===== Auth =====
  const btnSign = $('#btnSignIn');
  function disableBtn(seconds=50){
    let left=seconds; btnSign.disabled=true; const base=btnSign.textContent;
    const t=setInterval(()=>{ btnSign.textContent = `${base} (${left})`; left--; if(left<0){clearInterval(t); btnSign.disabled=false; btnSign.textContent=base;} },1000);
  }
  btnSign.addEventListener('click', async ()=>{
    try{
      if(!supabase) await initSupabaseClient();
      const email = ($('#email').value||'').trim();
      const password = ($('#password').value||'').trim();
      if(!email || !password){ alert('נא למלא אימייל וסיסמה'); return; }

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){
        const msg=(error.message||'').toLowerCase();
        if(msg.includes('not confirmed')){ authStatus.textContent='החשבון לא אומת. בדוק/י את המייל ואשר/י.'; return; }
        if(msg.includes('invalid login credentials')){ authStatus.textContent='אימייל/סיסמה לא נכונים.'; return; }
        if(msg.includes('rate')||msg.includes('too many')){ authStatus.textContent='יותר מדי ניסיונות. נסה/י שוב בעוד ~50 שניות.'; disableBtn(50); return; }
        // נרשום אוטומטית אם לא קיים
        const { error: signUpErr } = await supabase.auth.signUp({ email, password });
        if(signUpErr){ authStatus.textContent = 'שגיאת הרשמה: ' + signUpErr.message; if((signUpErr.message||'').toLowerCase().includes('rate')) disableBtn(50); return; }
        authStatus.textContent = 'נרשמת. אם אימות פעיל—יש לאשר מייל ואז להתחבר.';
        return;
      }
      currentUser = data.user;
      authStatus.textContent = 'מחובר כ-' + (currentUser?.email||'');
      refreshCustomers();
    }catch(e){ authStatus.textContent = 'שגיאה: ' + safeMsg(e); }
  });

  // ===== HTML → טבלה =====
  const fileInput = $('#fileInput'), tableSelect = $('#tableSelect');
  const dateSelect = $('#dateSelect'), nameSelect = $('#nameSelect'), amountSelect = $('#amountSelect');
  const btnPreview = $('#btnPreview'), btnImport = $('#btnImport'), importStatus = $('#importStatus');
  let tables=[], headers=[], rows=[];

  fileInput.addEventListener('change', async ()=>{
    const file=fileInput.files?.[0]; if(!file) return;
    const text=await file.text();
    const doc=new DOMParser().parseFromString(text,'text/html');
    tables=Array.from(doc.querySelectorAll('table')).sort((a,b)=>b.rows.length - a.rows.length);
    tableSelect.innerHTML=''; tables.forEach((t,i)=> tableSelect.add(new Option(`טבלה #${i+1} — ${t.rows.length} שורות`, i)));
    tableSelect.value='0'; prepareMapping();
  });
  tableSelect.addEventListener('change', prepareMapping);

  function prepareMapping(){
    const t = tables[parseInt(tableSelect.value||'0',10)]; if(!t) return;
    const trs = Array.from(t.querySelectorAll('tr')); if(trs.length===0){ headers=[]; rows=[]; return; }
    const first=trs[0]; const maybeTh=first.querySelectorAll('th');
    let headCells = maybeTh.length>0? Array.from(maybeTh) : Array.from(first.children);
    trs.shift();
    headers = headCells.map(th=>cleanText(th.textContent));
    rows = trs.map(tr=> Array.from(tr.children).map(td=> cleanText(td.textContent)));

    [dateSelect,nameSelect,amountSelect].forEach(s=> s.innerHTML='');
    headers.forEach((h,i)=> [dateSelect,nameSelect,amountSelect].forEach(sel=> sel.add(new Option(h, i))));
    const low=headers.map(h=>h.toLowerCase());
    const find = keys => { for(let i=0;i<low.length;i++) if(keys.some(k=>low[i].includes(k))) return i; return 0; };
    dateSelect.value   = String(find(['תאריך','date']));
    nameSelect.value   = String(find(['שם לקוח','לקוח','customer','client']));
    amountSelect.value = String(find(['סכום שובר','סכום','amount','total','₪','תשלום']));
  }

  btnPreview.addEventListener('click', ()=>{
    const dIdx=+dateSelect.value,nIdx=+nameSelect.value,aIdx=+amountSelect.value;
    const preview=rows.slice(0,20).map(r=>({date:normalizeDate(r[dIdx]||''),name:r[nIdx]||'',amount:parseAmount(r[aIdx]||'0')}));
    const total=preview.reduce((s,x)=>s+(x.amount||0),0);
    let html=`<div class="hint"><b>תצוגה מקדימה (עד 20)</b> | שורות: ${preview.length} | סכום: ${fmtILS(total)}</div>`;
    html+='<div style="max-height:320px;overflow:auto"><table><thead><tr><th>תאריך</th><th>שם לקוח</th><th>סכום</th></tr></thead><tbody>';
    preview.forEach(x=>{ html+=`<tr><td>${x.date}</td><td>${x.name}</td><td>${x.amount}</td></tr>`; });
    html+='</tbody></table></div>'; importStatus.innerHTML=html;
  });

  btnImport.addEventListener('click', async ()=>{
    try{
      if(!supabase) await initSupabaseClient();
      const { data: session } = await supabase.auth.getSession();
      if(!session||!session.session){ alert('יש להתחבר (Email+Password)'); return; }

      const dIdx=+dateSelect.value,nIdx=+nameSelect.value,aIdx=+amountSelect.value;
      const items=rows.map(r=>({date:normalizeDate(r[dIdx]||''),name:r[nIdx]||'',amount:parseAmount(r[aIdx]||'0')}))
                      .filter(x=>x.name&&x.date);

      importStatus.textContent='מייבא...';

      // upsert לקוחות לפי name
      const uniqueNames=Array.from(new Set(items.map(x=>x.name)));
      const customersToUpsert=uniqueNames.map(n=>({name:n}));
      const { error: custErr } = await supabase.from('customers').upsert(customersToUpsert, { onConflict:'name' });
      if(custErr){ importStatus.textContent='שגיאה ביצירת לקוחות: '+custErr.message; return; }

      // קריאת מזהים (customer_id)
      const { data: allCust, error: getCustErr } = await supabase.from('customers').select('customer_id,name').in('name', uniqueNames);
      if(getCustErr){ importStatus.textContent='שגיאה בקריאת לקוחות: '+getCustErr.message; return; }
      const idByName=Object.fromEntries((allCust||[]).map(c=>[c.name,c.customer_id]));

      // בניית שוברים
      const coupons=items.map(x=>({ customer_id:idByName[x.name], date:x.date, amount:x.amount, redeemed:false, source_label:'html-upload' }))
                         .filter(x=>x.customer_id);

      // upsert באצוות, מניעת כפילות לפי (customer_id,date)
      const chunkSize=500;
      for(let i=0;i<coupons.length;i+=chunkSize){
        const chunk=coupons.slice(i,i+chunkSize);
        const { error: coupErr } = await supabase.from('coupons').upsert(chunk, { onConflict:'customer_id,date' });
        if(coupErr){ importStatus.textContent='שגיאת ייבוא (אצווה): '+coupErr.message; return; }
      }

      importStatus.innerHTML='<span class="ok">הייבוא הושלם. מרענן נתונים…</span>';
      await refreshCustomers();
    }catch(e){ importStatus.textContent='שגיאה: '+safeMsg(e); }
  });

  // ===== לקוחות וסיכומים =====
  const customersWrap=$('#customersWrap'), customerCard=$('#customerCard'), custTitle=$('#custTitle'),
        btnBack=$('#btnBack'), couponsWrap=$('#couponsWrap'), btnRefresh=$('#btnRefresh');

  btnRefresh.addEventListener('click', refreshCustomers);

  async function refreshCustomers(){
    try{
      if(!supabase) await initSupabaseClient();
      const { data, error } = await supabase.from('customer_balances').select('*').order('name');
      if(error){ customersWrap.innerHTML='<span class="bad">שגיאה בקריאת נתונים: '+safeMsg(error)+'</span>'; return; }
      let html='<table><thead><tr><th>לקוח</th><th>סה״כ נטען</th><th>סה״כ מומש</th><th>יתרה זמינה</th><th></th></tr></thead><tbody>';
      (data||[]).forEach(r=>{
        html+=`<tr>
          <td>${r.name}</td>
          <td>${fmtILS(r.total_loaded)}</td>
          <td>${fmtILS(r.total_redeemed)}</td>
          <td><b>${fmtILS(r.available_amount)}</b></td>
          <td><button data-cid="${r.customer_id}" class="secondary btnOpen">פתח</button></td>
        </tr>`;
      });
      html+='</tbody></table>'; customersWrap.innerHTML=html;
      $$('.btnOpen').forEach(b=> b.addEventListener('click', ()=> openCustomer(b.getAttribute('data-cid'))));
    }catch(e){ customersWrap.innerHTML='<span class="bad">שגיאה: '+safeMsg(e)+'</span>'; }
  }

  async function openCustomer(customerId){
    try{
      const { data: cust, error: ce } = await supabase.from('customers').select('customer_id,name').eq('customer_id', customerId).single();
      if(ce){ alert('שגיאה: '+safeMsg(ce)); return; }
      custTitle.textContent='לקוח: '+cust.name;

      const { data: rows, error } = await supabase.from('coupons')
        .select('id,date,amount,redeemed,redeemed_at')
        .eq('customer_id', customerId).order('date', { ascending:false });
      if(error){ alert('שגיאת קריאה: '+safeMsg(error)); return; }

      let html='<table><thead><tr><th>תאריך</th><th>סכום</th><th>מומש</th><th>פעולה</th></tr></thead><tbody>';
      (rows||[]).forEach(r=>{
        html+=`<tr>
          <td>${r.date}</td>
          <td>${fmtILS(r.amount)}</td>
          <td>${r.redeemed ? `<span class="badge">✔️ ${r.redeemed_at? new Date(r.redeemed_at).toLocaleString('he-IL'):''}</span>` : ''}</td>
          <td>${r.redeemed ? '' : `<button class="secondary btnRedeem" data-id="${r.id}">סמן כמומש</button>`}</td>
        </tr>`;
      });
      html+='</tbody></table>';

      html+=`
        <div class="row" style="margin-top:12px">
          <div class="col"><label>תאריך</label><input id="manualDate" placeholder="YYYY-MM-DD" /></div>
          <div class="col"><label>סכום</label><input id="manualAmount" type="number" step="0.01" value="22" /></div>
          <div class="col" style="flex:0 0 220px;align-self:end">
            <button id="btnAddManual" class="primary">הוסף שובר ידני</button>
          </div>
        </div>`;
      couponsWrap.innerHTML=html; customerCard.style.display='block';

      $$('.btnRedeem').forEach(b=> b.addEventListener('click', ()=> markRedeemed(parseInt(b.getAttribute('data-id'),10))));
      $('#btnAddManual').addEventListener('click', async ()=>{
        const date=cleanText($('#manualDate').value);
        const amount=parseFloat($('#manualAmount').value||'22');
        if(!date){ alert('נא למלא תאריך'); return; }
        const { error } = await supabase.from('coupons').upsert(
          { customer_id: customerId, date, amount, redeemed:false, source_label:'manual' },
          { onConflict:'customer_id,date' }
        );
        if(error){ alert('שגיאה בהוספה: '+safeMsg(error)); return; }
        openCustomer(customerId); refreshCustomers();
      });
    }catch(e){ alert('שגיאה: '+safeMsg(e)); }
  }
  $('#btnBack').addEventListener('click', ()=>{ customerCard.style.display='none'; });

  async function markRedeemed(couponId){
    try{
      const { error } = await supabase.from('coupons').update({ redeemed:true, redeemed_at:new Date().toISOString() }).eq('id', couponId);
      if(error){ alert('שגיאת עדכון: '+safeMsg(error)); return; }
      const name=$('#custTitle').textContent.replace('לקוח: ','').trim();
      const { data: cust } = await supabase.from('customers').select('customer_id').eq('name', name).single();
      if(cust) openCustomer(cust.customer_id);
      refreshCustomers();
    }catch(e){ alert('שגיאה: '+safeMsg(e)); }
  }
</script>
</body>
</html>
